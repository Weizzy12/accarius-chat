<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–ü—Ä–∏–≤–∞—Ç–Ω—ã–π –ß–∞—Ç - –í—Ö–æ–¥</title>
    <link rel="stylesheet" href="style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>
<body>
    <div class="container">
        <!-- –®–∞–≥ 1: –í–≤–æ–¥ –∫–æ–¥–∞ -->
        <div class="login-box" id="step1">
            <h1><i class="fas fa-lock"></i> –ü—Ä–∏–≤–∞—Ç–Ω—ã–π –ß–∞—Ç</h1>
            <p>–î–ª—è –≤—Ö–æ–¥–∞ —Ç—Ä–µ–±—É–µ—Ç—Å—è –∏–Ω–≤–∞–π—Ç-–∫–æ–¥</p>
            
            <div class="form-group">
                <input type="text" 
                       id="inviteCode" 
                       placeholder="–í–≤–µ–¥–∏—Ç–µ –∏–Ω–≤–∞–π—Ç-–∫–æ–¥" 
                       class="form-input"
                       value="ADMIN123">
                <button class="btn btn-primary" onclick="checkCode()">
                    <i class="fas fa-key"></i> –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –∫–æ–¥
                </button>
            </div>
            
            <div id="error" class="error-message"></div>
            <div id="success" class="success-message"></div>
        </div>
        
        <!-- –®–∞–≥ 2: –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è -->
        <div class="login-box" id="step2" style="display: none;">
            <h1><i class="fas fa-user-plus"></i> –°–æ–∑–¥–∞–Ω–∏–µ –ø—Ä–æ—Ñ–∏–ª—è</h1>
            <p>–ö–æ–¥ –ø—Ä–∏–Ω—è—Ç! –ó–∞–ø–æ–ª–Ω–∏—Ç–µ –¥–∞–Ω–Ω—ã–µ:</p>
            
            <div class="form-group">
                <input type="text" 
                       id="nickname" 
                       placeholder="–í–∞—à–µ –∏–º—è –≤ —á–∞—Ç–µ" 
                       class="form-input">
                <input type="text" 
                       id="tgUsername" 
                       placeholder="@username –≤ Telegram" 
                       class="form-input">
                <button class="btn btn-primary" onclick="register()">
                    <i class="fas fa-sign-in-alt"></i> –í–æ–π—Ç–∏ –≤ —á–∞—Ç
                </button>
            </div>
            
            <div id="error2" class="error-message"></div>
        </div>
    </div>

    <script>
        // ========== –ì–õ–û–ë–ê–õ–¨–ù–´–ï –ü–ï–†–ï–ú–ï–ù–ù–´–ï ==========
        let currentCodeId = null;
        
        // ========== –§–£–ù–ö–¶–ò–Ø –ü–†–û–í–ï–†–ö–ò –ö–û–î–ê ==========
        async function checkCode() {
            console.log('üîê –ü—Ä–æ–≤–µ—Ä–∫–∞ –∏–Ω–≤–∞–π—Ç-–∫–æ–¥–∞...');
            
            const codeInput = document.getElementById('inviteCode');
            const code = codeInput.value.trim();
            
            // –í–∞–ª–∏–¥–∞—Ü–∏—è
            if (!code) {
                showError('–í–≤–µ–¥–∏—Ç–µ –∫–æ–¥ –¥–æ—Å—Ç—É–ø–∞');
                return;
            }
            
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∑–∞–≥—Ä—É–∑–∫—É
            const button = document.querySelector('#step1 .btn');
            const originalText = button.innerHTML;
            button.innerHTML = '<i class="fas fa-spinner fa-spin"></i> –ü—Ä–æ–≤–µ—Ä—è–µ–º...';
            button.disabled = true;
            
            try {
                // –û—Ç–ø—Ä–∞–≤–∫–∞ –∑–∞–ø—Ä–æ—Å–∞
                const response = await fetch('/api/check-code', {
                    method: 'POST',
                    headers: { 
                        'Content-Type': 'application/json',
                        'Accept': 'application/json'
                    },
                    body: JSON.stringify({ code: code })
                });
                
                // –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–∞—Ç—É—Å–∞
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const data = await response.json();
                console.log('–û—Ç–≤–µ—Ç —Å–µ—Ä–≤–µ—Ä–∞:', data);
                
                if (data.success) {
                    // –°–æ—Ö—Ä–∞–Ω—è–µ–º ID –∫–æ–¥–∞
                    currentCodeId = data.codeId;
                    
                    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —É—Å–ø–µ—Ö
                    showSuccess('‚úÖ –ö–æ–¥ –ø—Ä–∏–Ω—è—Ç! –ó–∞–ø–æ–ª–Ω–∏—Ç–µ –ø—Ä–æ—Ñ–∏–ª—å', 'step1');
                    
                    // –ü–µ—Ä–µ—Ö–æ–¥ –∫ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏
                    setTimeout(() => {
                        document.getElementById('step1').style.display = 'none';
                        document.getElementById('step2').style.display = 'block';
                        
                        // –ê–≤—Ç–æ—Ñ–æ–∫—É—Å –Ω–∞ –ø–æ–ª–µ –∏–º–µ–Ω–∏
                        const nicknameInput = document.getElementById('nickname');
                        nicknameInput.focus();
                    }, 1000);
                    
                } else {
                    showError(data.message || '–ù–µ–≤–µ—Ä–Ω—ã–π –∫–æ–¥ –¥–æ—Å—Ç—É–ø–∞', 'step1');
                }
                
            } catch (error) {
                console.error('‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –ø—Ä–æ–≤–µ—Ä–∫–µ –∫–æ–¥–∞:', error);
                showError('–û—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è —Å —Å–µ—Ä–≤–µ—Ä–æ–º. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç.', 'step1');
                
            } finally {
                // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∫–Ω–æ–ø–∫—É
                button.innerHTML = originalText;
                button.disabled = false;
            }
        }
        
        // ========== –§–£–ù–ö–¶–ò–Ø –†–ï–ì–ò–°–¢–†–ê–¶–ò–ò ==========
        async function register() {
            console.log('üë§ –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è...');
            
            const nickname = document.getElementById('nickname').value.trim();
            const tgUsername = document.getElementById('tgUsername').value.trim();
            
            // –í–∞–ª–∏–¥–∞—Ü–∏—è
            if (!nickname) {
                showError('–í–≤–µ–¥–∏—Ç–µ –∏–º—è –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –≤ —á–∞—Ç–µ', 'step2');
                return;
            }
            
            if (!tgUsername) {
                showError('–í–≤–µ–¥–∏—Ç–µ –≤–∞—à Telegram username', 'step2');
                return;
            }
            
            // –§–æ—Ä–º–∞—Ç–∏—Ä—É–µ–º Telegram username
            const formattedTg = tgUsername.startsWith('@') ? tgUsername : '@' + tgUsername;
            
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∑–∞–≥—Ä—É–∑–∫—É
            const button = document.querySelector('#step2 .btn');
            const originalText = button.innerHTML;
            button.innerHTML = '<i class="fas fa-spinner fa-spin"></i> –†–µ–≥–∏—Å—Ç—Ä–∏—Ä—É–µ–º...';
            button.disabled = true;
            
            try {
                // –û—Ç–ø—Ä–∞–≤–∫–∞ –∑–∞–ø—Ä–æ—Å–∞
                const response = await fetch('/api/register', {
                    method: 'POST',
                    headers: { 
                        'Content-Type': 'application/json',
                        'Accept': 'application/json'
                    },
                    body: JSON.stringify({
                        nickname: nickname,
                        tgUsername: formattedTg,
                        codeId: currentCodeId
                    })
                });
                
                // –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–∞—Ç—É—Å–∞
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const data = await response.json();
                console.log('–û—Ç–≤–µ—Ç —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏:', data);
                
                if (data.success) {
                    // –°–æ—Ö—Ä–∞–Ω—è–µ–º –¥–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
                    localStorage.setItem('chat_user', JSON.stringify(data.user));
                    console.log('‚úÖ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Å–æ—Ö—Ä–∞–Ω—ë–Ω:', data.user);
                    
                    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —É—Å–ø–µ—Ö
                    showSuccess('‚úÖ –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è —É—Å–ø–µ—à–Ω–∞! –ü–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–ª—è–µ–º –≤ —á–∞—Ç...', 'step2');
                    
                    // –ü–µ—Ä–µ—Ö–æ–¥ –≤ —á–∞—Ç
                    setTimeout(() => {
                        window.location.href = 'chat.html';
                    }, 1500);
                    
                } else {
                    showError(data.message || '–û—à–∏–±–∫–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏', 'step2');
                }
                
            } catch (error) {
                console.error('‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏:', error);
                showError('–û—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è —Å —Å–µ—Ä–≤–µ—Ä–æ–º', 'step2');
                
            } finally {
                // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∫–Ω–æ–ø–∫—É
                button.innerHTML = originalText;
                button.disabled = false;
            }
        }
        
        // ========== –í–°–ü–û–ú–û–ì–ê–¢–ï–õ–¨–ù–´–ï –§–£–ù–ö–¶–ò–ò ==========
        function showError(message, step) {
            console.error('‚ùå –û—à–∏–±–∫–∞:', message);
            
            const errorDiv = document.getElementById(step === 'step2' ? 'error2' : 'error');
            if (errorDiv) {
                errorDiv.innerHTML = `<i class="fas fa-exclamation-circle"></i> ${message}`;
                errorDiv.style.display = 'block';
                
                // –°–∫—Ä—ã–≤–∞–µ–º —á–µ—Ä–µ–∑ 5 —Å–µ–∫—É–Ω–¥
                setTimeout(() => {
                    errorDiv.style.display = 'none';
                }, 5000);
            }
            
            // –°–∫—Ä—ã–≤–∞–µ–º —É—Å–ø–µ—à–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –µ—Å–ª–∏ –µ—Å—Ç—å
            const successDiv = document.getElementById('success');
            if (successDiv) successDiv.style.display = 'none';
        }
        
        function showSuccess(message, step) {
            console.log('‚úÖ –£—Å–ø–µ—Ö:', message);
            
            const successDiv = document.getElementById('success');
            if (successDiv) {
                successDiv.innerHTML = `<i class="fas fa-check-circle"></i> ${message}`;
                successDiv.style.display = 'block';
            }
            
            // –°–∫—Ä—ã–≤–∞–µ–º –æ—à–∏–±–∫—É –µ—Å–ª–∏ –µ—Å—Ç—å
            const errorDiv = document.getElementById(step === 'step2' ? 'error2' : 'error');
            if (errorDiv) errorDiv.style.display = 'none';
        }
        
        // ========== –û–ë–†–ê–ë–û–¢–ß–ò–ö–ò –°–û–ë–´–¢–ò–ô ==========
        
        // Enter –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –∫–æ–¥–∞
        document.getElementById('inviteCode').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                e.preventDefault();
                checkCode();
            }
        });
        
        // Enter –¥–ª—è —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏
        document.getElementById('nickname').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                e.preventDefault();
                register();
            }
        });
        
        document.getElementById('tgUsername').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                e.preventDefault();
                register();
            }
        });
        
        // ========== –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø ==========
        window.addEventListener('DOMContentLoaded', function() {
            console.log('‚úÖ –°—Ç—Ä–∞–Ω–∏—Ü–∞ –≤—Ö–æ–¥–∞ –∑–∞–≥—Ä—É–∂–µ–Ω–∞');
            
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º API
            fetch('/api/test')
                .then(response => response.json())
                .then(data => {
                    console.log('API —Å—Ç–∞—Ç—É—Å:', data);
                    
                    // –ï—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —É–∂–µ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω - —Ä–µ–¥–∏—Ä–µ–∫—Ç –≤ —á–∞—Ç
                    const savedUser = localStorage.getItem('chat_user');
                    if (savedUser) {
                        console.log('–ù–∞–π–¥–µ–Ω —Å–æ—Ö—Ä–∞–Ω—ë–Ω–Ω—ã–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å, —Ä–µ–¥–∏—Ä–µ–∫—Ç...');
                        window.location.href = 'chat.html';
                    }
                })
                .catch(error => {
                    console.error('‚ùå API –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω:', error);
                    showError('–°–µ—Ä–≤–µ—Ä –≤—Ä–µ–º–µ–Ω–Ω–æ –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω', 'step1');
                });
                
            // –ê–≤—Ç–æ—Ñ–æ–∫—É—Å –Ω–∞ –ø–æ–ª–µ –∫–æ–¥–∞
            const codeInput = document.getElementById('inviteCode');
            if (codeInput) {
                codeInput.focus();
                codeInput.select();
            }
        });
        
        // ========== –î–ï–ë–ê–ì –§–£–ù–ö–¶–ò–ò ==========
        window.debugCheckCode = function() {
            console.log('üõ† –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω—ã–π –≤—ã–∑–æ–≤ checkCode()');
            checkCode();
        };
        
        window.debugRegister = function() {
            console.log('üõ† –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω—ã–π –≤—ã–∑–æ–≤ register()');
            register();
        };
    </script>
</body>
</html>