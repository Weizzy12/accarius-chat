<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–ü—Ä–∏–≤–∞—Ç–Ω—ã–π –ß–∞—Ç</title>
    <link rel="stylesheet" href="style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
</head>
<body>
    <div class="chat-container">
        <!-- –ë–æ–∫–æ–≤–∞—è –ø–∞–Ω–µ–ª—å —Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º–∏ -->
        <div class="sidebar">
            <div class="sidebar-header">
                <h3><i class="fas fa-users"></i> –û–Ω–ª–∞–π–Ω</h3>
                <span id="onlineCount">0</span>
            </div>
            <div id="usersList" class="users-list"></div>
            
            <div class="sidebar-footer">
                <div id="currentUser" class="current-user"></div>
                <button onclick="window.location.href='/admin.html'" id="adminBtn" style="display: block;">
                    <i class="fas fa-cog"></i> –ê–¥–º–∏–Ω–∫–∞
                </button>
            </div>
        </div>
        
        <!-- –û—Å–Ω–æ–≤–Ω–∞—è –æ–±–ª–∞—Å—Ç—å —á–∞—Ç–∞ -->
        <div class="chat-main">
            <!-- –ó–∞–≥–æ–ª–æ–≤–æ–∫ —á–∞—Ç–∞ -->
            <div class="chat-header">
                <h2><i class="fas fa-comments"></i> –û–±—â–∏–π —á–∞—Ç</h2>
                <div class="chat-info">
                    <span id="messageCount">0 —Å–æ–æ–±—â–µ–Ω–∏–π</span>
                </div>
            </div>
            
            <!-- –û–∫–Ω–æ —Å–æ–æ–±—â–µ–Ω–∏–π -->
            <div class="chat-messages" id="chatMessages">
                <!-- –°–æ–æ–±—â–µ–Ω–∏—è –∑–∞–≥—Ä—É–∂–∞—é—Ç—Å—è –∑–¥–µ—Å—å -->
            </div>
            
            <!-- –ü–∞–Ω–µ–ª—å –≤–≤–æ–¥–∞ -->
            <div class="chat-input-container">
                <input type="text" id="messageInput" placeholder="–ù–∞–ø–∏—à–∏—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏–µ..." class="message-input">
                <button onclick="sendMessage()" class="send-btn">
                    <i class="fas fa-paper-plane"></i>
                </button>
                <button onclick="testMessage()" class="btn btn-success" style="margin-left: 10px;">
                    <i class="fas fa-bolt"></i> –¢–µ—Å—Ç
                </button>
            </div>
        </div>
        
        <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –ø—Ä–æ—Ñ–∏–ª—è -->
        <div id="profileModal" class="modal">
            <div class="modal-content">
                <span class="close" onclick="closeProfile()">&times;</span>
                <div id="profileContent"></div>
                <div id="adminActions" style="display: none; margin-top: 20px;">
                    <h4>–î–µ–π—Å—Ç–≤–∏—è –∞–¥–º–∏–Ω–∞:</h4>
                    <button onclick="banUser()" class="btn btn-danger">
                        <i class="fas fa-ban"></i> –ó–∞–±–∞–Ω–∏—Ç—å
                    </button>
                    <button onclick="muteUser()" class="btn btn-warning">
                        <i class="fas fa-volume-mute"></i> –ú—É—Ç –Ω–∞ 5 –º–∏–Ω
                    </button>
                    <button onclick="makeAdmin()" class="btn btn-success">
                        <i class="fas fa-crown"></i> –°–¥–µ–ª–∞—Ç—å –∞–¥–º–∏–Ω–æ–º
                    </button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- –ü–æ–¥–∫–ª—é—á–∞–µ–º Socket.io –∫–ª–∏–µ–Ω—Ç -->
    <script src="/socket.io/socket.io.js"></script>
    <script>
        // ========== –û–°–ù–û–í–ù–´–ï –ü–ï–†–ï–ú–ï–ù–ù–´–ï ==========
        let currentUser = {
            id: 1,
            nickname: '–ê–¥–º–∏–Ω',
            role: 'admin',
            avatar_color: '#3498db'
        };
        let selectedUserId = null;
        let onlineUsers = [];
        
        // ========== WebSocket ==========
        const socket = io(window.location.origin, {
            transports: ['websocket', 'polling'],
            reconnection: true
        });
        
        // ========== –°–ò–°–¢–ï–ú–ù–´–ï –§–£–ù–ö–¶–ò–ò ==========
        
        // 1. –ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        async function loadUserData() {
            try {
                const response = await fetch('/api/user');
                const data = await response.json();
                
                if (data.success) {
                    currentUser = data.user;
                    console.log('‚úÖ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∑–∞–≥—Ä—É–∂–µ–Ω:', currentUser);
                } else {
                    console.log('‚ö†Ô∏è –ò—Å–ø–æ–ª—å–∑—É–µ–º —Ç–µ—Å—Ç–æ–≤–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è');
                }
                
                // –í–°–ï–ì–î–ê –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –∫–Ω–æ–ø–∫—É –∞–¥–º–∏–Ω–∫–∏
                document.getElementById('adminBtn').style.display = 'block';
                updateCurrentUserDisplay();
                
            } catch (error) {
                console.error('‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è:', error);
                document.getElementById('adminBtn').style.display = 'block';
                updateCurrentUserDisplay();
            }
        }
        
        // 2. –û–±–Ω–æ–≤–∏—Ç—å –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ —Ç–µ–∫—É—â–µ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        function updateCurrentUserDisplay() {
            const userDiv = document.getElementById('currentUser');
            if (userDiv) {
                userDiv.innerHTML = `
                    <div class="user-avatar" style="background-color: ${currentUser.avatar_color}">
                        ${currentUser.nickname.charAt(0).toUpperCase()}
                    </div>
                    <div class="user-info">
                        <strong>${currentUser.nickname}</strong>
                        <small>${currentUser.role === 'admin' ? 'üëë –ê–¥–º–∏–Ω' : 'üë§ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å'}</small>
                    </div>
                `;
            }
        }
        
        // 3. –û—Ç–ø—Ä–∞–≤–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏—è
        function sendMessage() {
            const input = document.getElementById('messageInput');
            const text = input.value.trim();
            
            if (!text) {
                console.log('‚ö†Ô∏è –ü—É—Å—Ç–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ');
                return;
            }
            
            if (!socket.connected) {
                console.error('‚ùå WebSocket –Ω–µ –ø–æ–¥–∫–ª—é—á–µ–Ω!');
                alert('–ù–µ—Ç —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è! –û–±–Ω–æ–≤–∏ —Å—Ç—Ä–∞–Ω–∏—Ü—É.');
                return;
            }
            
            console.log('üì§ –û—Ç–ø—Ä–∞–≤–ª—è—é:', text);
            
            socket.emit('send_message', {
                userId: currentUser.id,
                text: text
            });
            
            input.value = '';
            input.focus();
        }
        
        // 4. –¢–µ—Å—Ç–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ
        function testMessage() {
            if (!socket.connected) {
                alert('WebSocket –Ω–µ –ø–æ–¥–∫–ª—é—á–µ–Ω!');
                return;
            }
            
            socket.emit('send_message', {
                userId: 999,
                text: '–¢–µ—Å—Ç–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ ' + new Date().toLocaleTimeString()
            });
            
            alert('–¢–µ—Å—Ç–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ!');
        }
        
        // 5. –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ —Å–æ–æ–±—â–µ–Ω–∏–π
        function displayMessages(messages) {
            const container = document.getElementById('chatMessages');
            if (!container) return;
            
            container.innerHTML = '';
            
            messages.forEach(msg => {
                const messageDiv = document.createElement('div');
                messageDiv.className = 'message';
                messageDiv.innerHTML = `
                    <div class="message-avatar" style="background-color: ${msg.avatar_color}"
                         onclick="showProfile(${msg.user_id})">
                        ${msg.nickname.charAt(0).toUpperCase()}
                    </div>
                    <div class="message-content">
                        <div class="message-header">
                            <strong class="message-sender" onclick="showProfile(${msg.user_id})">
                                ${msg.nickname}
                                ${msg.role === 'admin' ? 'üëë' : ''}
                            </strong>
                            <span class="message-time">${formatTime(msg.timestamp)}</span>
                        </div>
                        <div class="message-text">${msg.text}</div>
                    </div>
                `;
                container.appendChild(messageDiv);
            });
            
            container.scrollTop = container.scrollHeight;
        }
        
        // ========== WebSocket –°–û–ë–´–¢–ò–Ø ==========
        
        socket.on('connect', () => {
            console.log('‚úÖ WebSocket –ø–æ–¥–∫–ª—é—á–µ–Ω!');
            socket.emit('get_history');
        });
        
        socket.on('message_history', (messages) => {
            console.log('üìú –ò—Å—Ç–æ—Ä–∏—è:', messages.length, '—Å–æ–æ–±—â–µ–Ω–∏–π');
            displayMessages(messages);
        });
        
        socket.on('new_message', (message) => {
            console.log('üì® –ù–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ:', message.text);
            
            const container = document.getElementById('chatMessages');
            if (!container) return;
            
            const messageDiv = document.createElement('div');
            messageDiv.className = 'message';
            messageDiv.innerHTML = `
                <div class="message-avatar" style="background-color: ${message.user.avatar_color}"
                     onclick="showProfile(${message.user.id})">
                    ${message.user.nickname.charAt(0).toUpperCase()}
                </div>
                <div class="message-content">
                    <div class="message-header">
                        <strong class="message-sender" onclick="showProfile(${message.user.id})">
                            ${message.user.nickname}
                            ${message.user.role === 'admin' ? 'üëë' : ''}
                        </strong>
                        <span class="message-time">${formatTime(message.timestamp)}</span>
                    </div>
                    <div class="message-text">${message.text}</div>
                </div>
            `;
            container.appendChild(messageDiv);
            container.scrollTop = container.scrollHeight;
        });
        
        socket.on('error', (data) => {
            console.error('‚ùå WebSocket –æ—à–∏–±–∫–∞:', data);
        });
        
        socket.on('disconnect', () => {
            console.log('‚ùå WebSocket –æ—Ç–∫–ª—é—á–µ–Ω');
        });
        
        // ========== –í–°–ü–û–ú–û–ì–ê–¢–ï–õ–¨–ù–´–ï –§–£–ù–ö–¶–ò–ò ==========
        
        function formatTime(timestamp) {
            const date = new Date(timestamp);
            return date.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
        }
        
        // ========== –ê–î–ú–ò–ù –§–£–ù–ö–¶–ò–ò ==========
        
        function showProfile(userId) {
            alert('–ü—Ä–æ—Ñ–∏–ª—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è ID: ' + userId);
        }
        
        function banUser() {
            alert('–ë–∞–Ω –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è');
        }
        
        function muteUser() {
            alert('–ú—É—Ç –Ω–∞ 5 –º–∏–Ω—É—Ç');
        }
        
        function makeAdmin() {
            alert('–°–¥–µ–ª–∞—Ç—å –∞–¥–º–∏–Ω–æ–º');
        }
        
        function closeProfile() {
            const modal = document.getElementById('profileModal');
            if (modal) {
                modal.style.display = 'none';
            }
        }
        
        // ========== –ö–õ–ê–í–ò–ê–¢–£–†–ê ==========
        
        document.getElementById('messageInput')?.addEventListener('keypress', function(e) {
            if (e.key === 'Enter') sendMessage();
        });
        
        // ========== –ó–ê–ì–†–£–ó–ö–ê –°–¢–†–ê–ù–ò–¶–´ ==========
        
        document.addEventListener('DOMContentLoaded', function() {
            console.log('üöÄ –ß–∞—Ç –∑–∞–≥—Ä—É–∂–∞–µ—Ç—Å—è...');
            loadUserData();
        });
    </script>
</body>
</html>
