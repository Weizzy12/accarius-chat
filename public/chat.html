<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–ü—Ä–∏–≤–∞—Ç–Ω—ã–π –ß–∞—Ç</title>
    <link rel="stylesheet" href="style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
</head>
<body>
    <div class="chat-container">
        <!-- –ë–æ–∫–æ–≤–∞—è –ø–∞–Ω–µ–ª—å —Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º–∏ -->
        <div class="sidebar">
            <div class="sidebar-header">
                <h3><i class="fas fa-users"></i> –û–Ω–ª–∞–π–Ω</h3>
                <span id="onlineCount">0</span>
            </div>
            <div id="usersList" class="users-list"></div>
            
            <div class="sidebar-footer">
                <div id="currentUser" class="current-user"></div>
                <button onclick="window.location.href='/admin.html'" id="adminBtn" style="display: none;">
                    <i class="fas fa-cog"></i> –ê–¥–º–∏–Ω–∫–∞
                </button>
            </div>
        </div>
        
        <!-- –û—Å–Ω–æ–≤–Ω–∞—è –æ–±–ª–∞—Å—Ç—å —á–∞—Ç–∞ -->
        <div class="chat-main">
            <!-- –ó–∞–≥–æ–ª–æ–≤–æ–∫ —á–∞—Ç–∞ -->
            <div class="chat-header">
                <h2><i class="fas fa-comments"></i> –û–±—â–∏–π —á–∞—Ç</h2>
                <div class="chat-info">
                    <span id="messageCount">0 —Å–æ–æ–±—â–µ–Ω–∏–π</span>
                    <button onclick="testConnection()" class="btn btn-warning" style="margin-left: 10px; padding: 8px 15px;">
                        <i class="fas fa-wifi"></i> –¢–µ—Å—Ç
                    </button>
                </div>
            </div>
            
            <!-- –û–∫–Ω–æ —Å–æ–æ–±—â–µ–Ω–∏–π -->
            <div class="chat-messages" id="chatMessages">
                <!-- –°–æ–æ–±—â–µ–Ω–∏—è –∑–∞–≥—Ä—É–∂–∞—é—Ç—Å—è –∑–¥–µ—Å—å -->
            </div>
            
            <!-- –ü–∞–Ω–µ–ª—å –≤–≤–æ–¥–∞ -->
            <div class="chat-input-container">
                <input type="text" id="messageInput" placeholder="–ù–∞–ø–∏—à–∏—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏–µ..." class="message-input">
                <button onclick="sendMessage()" class="send-btn">
                    <i class="fas fa-paper-plane"></i>
                </button>
            </div>
        </div>
        
        <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –ø—Ä–æ—Ñ–∏–ª—è -->
        <div id="profileModal" class="modal">
            <div class="modal-content">
                <span class="close" onclick="closeProfile()">&times;</span>
                <div id="profileContent"></div>
                <div id="adminActions" style="display: none; margin-top: 20px;">
                    <h4>–î–µ–π—Å—Ç–≤–∏—è –∞–¥–º–∏–Ω–∞:</h4>
                    <button onclick="banUser()" class="btn btn-danger">
                        <i class="fas fa-ban"></i> –ó–∞–±–∞–Ω–∏—Ç—å
                    </button>
                    <button onclick="muteUser()" class="btn btn-warning">
                        <i class="fas fa-volume-mute"></i> –ú—É—Ç –Ω–∞ 5 –º–∏–Ω
                    </button>
                    <button onclick="makeAdmin()" class="btn btn-success">
                        <i class="fas fa-crown"></i> –°–¥–µ–ª–∞—Ç—å –∞–¥–º–∏–Ω–æ–º
                    </button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- –ü–æ–¥–∫–ª—é—á–∞–µ–º Socket.io –∫–ª–∏–µ–Ω—Ç -->
    <script src="/socket.io/socket.io.js"></script>
    <script>
        // ========== –ì–õ–û–ë–ê–õ–¨–ù–´–ï –ü–ï–†–ï–ú–ï–ù–ù–´–ï ==========
        const socket = io(window.location.origin, {
            transports: ['websocket', 'polling'],
            reconnection: true,
            reconnectionAttempts: 10,
            reconnectionDelay: 1000
        });
        
        let currentUser = JSON.parse(localStorage.getItem('user') || '{}');
        let selectedUserId = null;
        let onlineUsers = [];
        
        // ========== –û–°–ù–û–í–ù–´–ï –§–£–ù–ö–¶–ò–ò ==========
        
        // 1. –ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        async function loadUserData() {
            console.log('üë§ –ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è...');
            
            try {
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å—Ç—å –ª–∏ —Å–æ—Ö—Ä–∞–Ω—ë–Ω–Ω—ã–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å
                if (currentUser && currentUser.id) {
                    console.log('‚úÖ –ò—Å–ø–æ–ª—å–∑—É–µ–º —Å–æ—Ö—Ä–∞–Ω—ë–Ω–Ω–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è:', currentUser.nickname);
                    updateCurrentUserDisplay();
                    
                    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∫–Ω–æ–ø–∫—É –∞–¥–º–∏–Ω–∫–∏ –µ—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∞–¥–º–∏–Ω
                    if (currentUser.role === 'admin') {
                        document.getElementById('adminBtn').style.display = 'block';
                    }
                    
                    // –°–æ–æ–±—â–∞–µ–º —Å–µ—Ä–≤–µ—Ä—É –æ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–∏
                    if (socket.connected) {
                        socket.emit('user_online', {
                            id: currentUser.id,
                            nickname: currentUser.nickname,
                            avatar_color: currentUser.avatar_color
                        });
                    }
                    
                    return;
                }
                
                // –ï—Å–ª–∏ –Ω–µ—Ç —Å–æ—Ö—Ä–∞–Ω—ë–Ω–Ω–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è, –∑–∞–ø—Ä–∞—à–∏–≤–∞–µ–º —É —Å–µ—Ä–≤–µ—Ä–∞
                console.log('üì° –ó–∞–ø—Ä–∞—à–∏–≤–∞–µ–º –¥–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è —Å —Å–µ—Ä–≤–µ—Ä–∞...');
                const response = await fetch('/api/user', {
                    headers: {
                        'Authorization': JSON.stringify(currentUser),
                        'Content-Type': 'application/json'
                    }
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const data = await response.json();
                console.log('üìä –û—Ç–≤–µ—Ç —Å–µ—Ä–≤–µ—Ä–∞:', data);
                
                if (data.success) {
                    currentUser = data.user;
                    localStorage.setItem('user', JSON.stringify(data.user));
                    
                    console.log('‚úÖ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ø–æ–ª—É—á–µ–Ω:', currentUser.nickname);
                    updateCurrentUserDisplay();
                    
                    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∫–Ω–æ–ø–∫—É –∞–¥–º–∏–Ω–∫–∏ –µ—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∞–¥–º–∏–Ω
                    if (currentUser.role === 'admin') {
                        document.getElementById('adminBtn').style.display = 'block';
                        console.log('üëë –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∞–¥–º–∏–Ω, –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –∫–Ω–æ–ø–∫—É –∞–¥–º–∏–Ω–∫–∏');
                    }
                    
                    // –°–æ–æ–±—â–∞–µ–º —Å–µ—Ä–≤–µ—Ä—É –æ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–∏
                    if (socket.connected) {
                        socket.emit('user_online', {
                            id: currentUser.id,
                            nickname: currentUser.nickname,
                            avatar_color: currentUser.avatar_color
                        });
                    }
                } else {
                    console.error('‚ùå –û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è:', data.message);
                    window.location.href = '/index.html';
                }
                
            } catch (error) {
                console.error('‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è:', error);
                
                // –ï—Å–ª–∏ –æ—à–∏–±–∫–∞, –ø—Ä–æ–±—É–µ–º –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —Ç–µ—Å—Ç–æ–≤–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
                if (!currentUser.id) {
                    currentUser = {
                        id: 1,
                        nickname: '–¢–µ—Å—Ç–æ–≤—ã–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å',
                        role: 'user',
                        avatar_color: '#3498db'
                    };
                    updateCurrentUserDisplay();
                }
            }
        }
        
        // 2. –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è —Ç–µ–∫—É—â–µ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        function updateCurrentUserDisplay() {
            const userDiv = document.getElementById('currentUser');
            if (userDiv) {
                userDiv.innerHTML = `
                    <div class="user-avatar" style="background-color: ${currentUser.avatar_color}">
                        ${currentUser.nickname.charAt(0).toUpperCase()}
                    </div>
                    <div class="user-info">
                        <strong>${currentUser.nickname}</strong>
                        <small>${currentUser.role === 'admin' ? 'üëë –ê–¥–º–∏–Ω' : 'üë§ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å'}</small>
                    </div>
                `;
            }
        }
        
        // 3. –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å–ø–∏—Å–∫–∞ –æ–Ω–ª–∞–π–Ω –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
        function updateOnlineUsers(users) {
            onlineUsers = users;
            const usersList = document.getElementById('usersList');
            const onlineCount = document.getElementById('onlineCount');
            
            if (usersList && onlineCount) {
                usersList.innerHTML = '';
                onlineCount.textContent = users.length;
                
                users.forEach(user => {
                    const userDiv = document.createElement('div');
                    userDiv.className = 'online-user';
                    userDiv.onclick = () => showProfile(user.id);
                    userDiv.innerHTML = `
                        <div class="user-avatar-small" style="background-color: ${user.avatar_color}">
                            ${user.nickname.charAt(0).toUpperCase()}
                        </div>
                        <div class="user-details">
                            <strong>${user.nickname}</strong>
                            ${user.role === 'admin' ? '<small>üëë</small>' : ''}
                        </div>
                    `;
                    usersList.appendChild(userDiv);
                });
            }
        }
        
        // 4. –û—Ç–ø—Ä–∞–≤–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏—è
        function sendMessage() {
            const input = document.getElementById('messageInput');
            const text = input.value.trim();
            
            if (!text || !currentUser.id) {
                console.log('‚ö†Ô∏è –ü—É—Å—Ç–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –∏–ª–∏ –Ω–µ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è');
                return;
            }
            
            if (!socket.connected) {
                console.error('‚ùå WebSocket –Ω–µ –ø–æ–¥–∫–ª—é—á–µ–Ω!');
                alert('–ù–µ—Ç —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è —Å —Å–µ—Ä–≤–µ—Ä–æ–º. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –æ–±–Ω–æ–≤–∏—Ç–µ —Å—Ç—Ä–∞–Ω–∏—Ü—É.');
                return;
            }
            
            console.log('üì§ –û—Ç–ø—Ä–∞–≤–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏—è:', text);
            
            socket.emit('send_message', {
                userId: currentUser.id,
                text: text
            });
            
            input.value = '';
            input.focus();
        }
        
        // 5. –ó–∞–≥—Ä—É–∑–∫–∞ –∏—Å—Ç–æ—Ä–∏–∏ —Å–æ–æ–±—â–µ–Ω–∏–π
        async function loadMessages() {
            try {
                console.log('üìú –ó–∞–≥—Ä—É–∑–∫–∞ –∏—Å—Ç–æ—Ä–∏–∏ —Å–æ–æ–±—â–µ–Ω–∏–π...');
                const response = await fetch('/api/messages');
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const data = await response.json();
                
                if (data.success) {
                    console.log(`‚úÖ –ó–∞–≥—Ä—É–∂–µ–Ω–æ ${data.messages.length} —Å–æ–æ–±—â–µ–Ω–∏–π`);
                    displayMessages(data.messages);
                    document.getElementById('messageCount').textContent = 
                        `${data.messages.length} —Å–æ–æ–±—â–µ–Ω–∏–π`;
                } else {
                    console.error('‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏–π:', data.message);
                }
            } catch (error) {
                console.error('‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏–π:', error);
            }
        }
        
        // 6. –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ —Å–æ–æ–±—â–µ–Ω–∏–π
        function displayMessages(messages) {
            const container = document.getElementById('chatMessages');
            if (!container) return;
            
            container.innerHTML = '';
            
            messages.forEach(msg => {
                const messageDiv = document.createElement('div');
                messageDiv.className = 'message';
                messageDiv.innerHTML = `
                    <div class="message-avatar" style="background-color: ${msg.avatar_color}"
                         onclick="showProfile(${msg.user_id})">
                        ${msg.nickname.charAt(0).toUpperCase()}
                    </div>
                    <div class="message-content">
                        <div class="message-header">
                            <strong class="message-sender" onclick="showProfile(${msg.user_id})">
                                ${msg.nickname}
                                ${msg.role === 'admin' ? 'üëë' : ''}
                            </strong>
                            <span class="message-time">${formatTime(msg.timestamp)}</span>
                        </div>
                        <div class="message-text">${escapeHtml(msg.text)}</div>
                    </div>
                `;
                container.appendChild(messageDiv);
            });
            
            // –ü—Ä–æ–∫—Ä—É—Ç–∫–∞ –≤–Ω–∏–∑
            container.scrollTop = container.scrollHeight;
        }
        
        // 7. –ü–æ–∫–∞–∑–∞—Ç—å –ø—Ä–æ—Ñ–∏–ª—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        function showProfile(userId) {
            selectedUserId = userId;
            const modal = document.getElementById('profileModal');
            const adminActions = document.getElementById('adminActions');
            
            console.log('üë§ –ó–∞–≥—Ä—É–∑–∫–∞ –ø—Ä–æ—Ñ–∏–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è ID:', userId);
            
            // –ó–∞–≥—Ä—É–∂–∞–µ–º –¥–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
            fetch(`/api/user/${userId}`)
                .then(res => {
                    if (!res.ok) {
                        throw new Error(`HTTP error! status: ${res.status}`);
                    }
                    return res.json();
                })
                .then(data => {
                    if (data.success) {
                        const user = data.user;
                        console.log('‚úÖ –ü—Ä–æ—Ñ–∏–ª—å –∑–∞–≥—Ä—É–∂–µ–Ω:', user.nickname);
                        
                        document.getElementById('profileContent').innerHTML = `
                            <div style="text-align: center;">
                                <div class="profile-avatar" style="background-color: ${user.avatar_color}; 
                                     margin: 0 auto 15px; width: 80px; height: 80px; font-size: 32px; 
                                     display: flex; align-items: center; justify-content: center; 
                                     border-radius: 50%; color: white; font-weight: bold;">
                                    ${user.nickname.charAt(0).toUpperCase()}
                                </div>
                                <h3>${user.nickname}</h3>
                                <p><strong>Telegram:</strong> ${user.tg_username || '–ù–µ —É–∫–∞–∑–∞–Ω'}</p>
                                <p><strong>–†–æ–ª—å:</strong> ${user.role === 'admin' ? 'üëë –ê–¥–º–∏–Ω' : 'üë§ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å'}</p>
                                <p><strong>–ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω:</strong> ${new Date(user.created_at).toLocaleDateString()}</p>
                                <p><strong>–°—Ç–∞—Ç—É—Å:</strong> ${user.is_banned ? '‚ùå –ó–∞–±–∞–Ω–µ–Ω' : '‚úÖ –ê–∫—Ç–∏–≤–µ–Ω'}</p>
                            </div>
                        `;
                        
                        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∫–Ω–æ–ø–∫–∏ –∞–¥–º–∏–Ω–∞ —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ —Ç–µ–∫—É—â–∏–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∞–¥–º–∏–Ω
                        if (currentUser.role === 'admin' && user.id !== currentUser.id) {
                            adminActions.style.display = 'block';
                        } else {
                            adminActions.style.display = 'none';
                        }
                        
                        modal.style.display = 'block';
                    } else {
                        console.error('‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –ø—Ä–æ—Ñ–∏–ª—è:', data.message);
                        alert('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –ø—Ä–æ—Ñ–∏–ª—è: ' + data.message);
                    }
                })
                .catch(error => {
                    console.error('‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –ø—Ä–æ—Ñ–∏–ª—è:', error);
                    alert('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –ø—Ä–æ—Ñ–∏–ª—è. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ —Å —Å–µ—Ä–≤–µ—Ä–æ–º.');
                });
        }
        
        // 8. –ó–∞–∫—Ä—ã—Ç—å –ø—Ä–æ—Ñ–∏–ª—å
        function closeProfile() {
            const modal = document.getElementById('profileModal');
            if (modal) {
                modal.style.display = 'none';
            }
        }
        
        // 9. –î–µ–π—Å—Ç–≤–∏—è –∞–¥–º–∏–Ω–∞
        async function banUser() {
            if (!selectedUserId) return;
            if (!confirm('–ó–∞–±–∞–Ω–∏—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è?')) return;
            
            try {
                const response = await fetch('/api/admin/ban-user', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ 
                        userId: selectedUserId, 
                        action: 'ban' 
                    })
                });
                
                const data = await response.json();
                if (data.success) {
                    alert('–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∑–∞–±–∞–Ω–µ–Ω');
                    closeProfile();
                } else {
                    alert('–û—à–∏–±–∫–∞: ' + data.message);
                }
            } catch (error) {
                console.error('‚ùå –û—à–∏–±–∫–∞ –±–∞–Ω–∞:', error);
                alert('–û—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è —Å —Å–µ—Ä–≤–µ—Ä–æ–º');
            }
        }
        
        async function muteUser() {
            if (!selectedUserId) return;
            
            try {
                const response = await fetch('/api/admin/user-action', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ 
                        adminId: currentUser.id,
                        targetUserId: selectedUserId, 
                        action: 'mute',
                        duration: 5
                    })
                });
                
                const data = await response.json();
                if (data.success) {
                    alert('–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∑–∞–º—å—é—á–µ–Ω –Ω–∞ 5 –º–∏–Ω—É—Ç');
                    closeProfile();
                } else {
                    alert('–û—à–∏–±–∫–∞: ' + data.message);
                }
            } catch (error) {
                console.error('‚ùå –û—à–∏–±–∫–∞ –º—É—Ç–∞:', error);
                alert('–û—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è —Å —Å–µ—Ä–≤–µ—Ä–æ–º');
            }
        }
        
        async function makeAdmin() {
            if (!selectedUserId) return;
            if (!confirm('–°–¥–µ–ª–∞—Ç—å —ç—Ç–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∞–¥–º–∏–Ω–æ–º?')) return;
            
            try {
                const response = await fetch('/api/admin/ban-user', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ 
                        userId: selectedUserId, 
                        action: 'make_admin' 
                    })
                });
                
                const data = await response.json();
                if (data.success) {
                    alert('–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Ç–µ–ø–µ—Ä—å –∞–¥–º–∏–Ω');
                    closeProfile();
                } else {
                    alert('–û—à–∏–±–∫–∞: ' + data.message);
                }
            } catch (error) {
                console.error('‚ùå –û—à–∏–±–∫–∞ –Ω–∞–∑–Ω–∞—á–µ–Ω–∏—è –∞–¥–º–∏–Ω–∞:', error);
                alert('–û—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è —Å —Å–µ—Ä–≤–µ—Ä–æ–º');
            }
        }
        
        // 10. –¢–µ—Å—Ç —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è
        function testConnection() {
            console.log('üîß –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è...');
            
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º API
            fetch('/api/test')
                .then(res => res.json())
                .then(data => {
                    console.log('‚úÖ API —Ç–µ—Å—Ç:', data);
                    
                    // –ü—Ä–æ–≤–µ—Ä—è–µ–º WebSocket
                    if (socket.connected) {
                        console.log('‚úÖ WebSocket –ø–æ–¥–∫–ª—é—á–µ–Ω:', socket.id);
                        alert('‚úÖ –°–æ–µ–¥–∏–Ω–µ–Ω–∏–µ –æ—Ç–ª–∏—á–Ω–æ!\nAPI: –†–∞–±–æ—Ç–∞–µ—Ç\nWebSocket: –ü–æ–¥–∫–ª—é—á–µ–Ω\nID: ' + socket.id);
                    } else {
                        console.log('‚ùå WebSocket –Ω–µ –ø–æ–¥–∫–ª—é—á–µ–Ω');
                        alert('‚ö†Ô∏è API —Ä–∞–±–æ—Ç–∞–µ—Ç, –Ω–æ WebSocket –Ω–µ –ø–æ–¥–∫–ª—é—á–µ–Ω. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –æ–±–Ω–æ–≤–∏—Ç—å —Å—Ç—Ä–∞–Ω–∏—Ü—É.');
                    }
                })
                .catch(error => {
                    console.error('‚ùå API —Ç–µ—Å—Ç –Ω–µ –ø—Ä–æ—à—ë–ª:', error);
                    alert('‚ùå –ù–µ—Ç —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è —Å —Å–µ—Ä–≤–µ—Ä–æ–º. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç –∏–ª–∏ –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∏—Ç–µ —Å—Ç—Ä–∞–Ω–∏—Ü—É.');
                });
        }
        
        // ========== –í–°–ü–û–ú–û–ì–ê–¢–ï–õ–¨–ù–´–ï –§–£–ù–ö–¶–ò–ò ==========
        
        function formatTime(timestamp) {
            const date = new Date(timestamp);
            return date.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
        }
        
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }
        
        // ========== WebSocket –°–û–ë–´–¢–ò–Ø ==========
        
        socket.on('connect', () => {
            console.log('‚úÖ WebSocket –ø–æ–¥–∫–ª—é—á–µ–Ω! ID:', socket.id);
            socket.emit('get_history');
            
            // –ï—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω, —Å–æ–æ–±—â–∞–µ–º –æ –µ–≥–æ –æ–Ω–ª–∞–π–Ω-—Å—Ç–∞—Ç—É—Å–µ
            if (currentUser.id) {
                socket.emit('user_online', {
                    id: currentUser.id,
                    nickname: currentUser.nickname,
                    avatar_color: currentUser.avatar_color
                });
            }
        });
        
        socket.on('message_history', (messages) => {
            console.log('üìú –ü–æ–ª—É—á–µ–Ω–∞ –∏—Å—Ç–æ—Ä–∏—è —Å–æ–æ–±—â–µ–Ω–∏–π:', messages.length);
            displayMessages(messages);
        });
        
        socket.on('new_message', (message) => {
            console.log('üì® –ù–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –ø–æ–ª—É—á–µ–Ω–æ:', message.text);
            
            const messagesContainer = document.getElementById('chatMessages');
            if (!messagesContainer) return;
            
            const messageDiv = document.createElement('div');
            messageDiv.className = 'message';
            messageDiv.innerHTML = `
                <div class="message-avatar" style="background-color: ${message.user.avatar_color}"
                     onclick="showProfile(${message.user.id})">
                    ${message.user.nickname.charAt(0).toUpperCase()}
                </div>
                <div class="message-content">
                    <div class="message-header">
                        <strong class="message-sender" onclick="showProfile(${message.user.id})">
                            ${message.user.nickname}
                            ${message.user.role === 'admin' ? 'üëë' : ''}
                        </strong>
                        <span class="message-time">${formatTime(message.timestamp)}</span>
                    </div>
                    <div class="message-text">${escapeHtml(message.text)}</div>
                </div>
            `;
            messagesContainer.appendChild(messageDiv);
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
            
            // –û–±–Ω–æ–≤–ª—è–µ–º —Å—á–µ—Ç—á–∏–∫ —Å–æ–æ–±—â–µ–Ω–∏–π
            const messageCount = document.getElementById('messageCount');
            if (messageCount) {
                const current = parseInt(messageCount.textContent) || 0;
                messageCount.textContent = `${current + 1} —Å–æ–æ–±—â–µ–Ω–∏–π`;
            }
        });
        
        socket.on('update_online_users', (users) => {
            console.log('üë• –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –æ–Ω–ª–∞–π–Ω –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π:', users.length);
            updateOnlineUsers(users);
        });
        
        socket.on('admin_action', (data) => {
            console.log('üî® –î–µ–π—Å—Ç–≤–∏–µ –∞–¥–º–∏–Ω–∞:', data);
            if (data.userId === currentUser.id && data.action === 'ban') {
                alert('–í—ã –±—ã–ª–∏ –∑–∞–±–∞–Ω–µ–Ω—ã!');
                localStorage.removeItem('user');
                window.location.href = '/index.html';
            }
        });
        
        socket.on('error', (data) => {
            console.error('‚ùå WebSocket –æ—à–∏–±–∫–∞:', data);
            alert('–û—à–∏–±–∫–∞ WebSocket: ' + data.message);
        });
        
        socket.on('disconnect', () => {
            console.log('‚ùå WebSocket –æ—Ç–∫–ª—é—á–µ–Ω');
        });
        
        socket.on('connect_error', (error) => {
            console.error('‚ùå –û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è WebSocket:', error);
        });
        
        // ========== –û–ë–†–ê–ë–û–¢–ß–ò–ö–ò –°–û–ë–´–¢–ò–ô ==========
        
        document.getElementById('messageInput')?.addEventListener('keypress', function(e) {
            if (e.key === 'Enter') sendMessage();
        });
        
        window.onclick = function(event) {
            const modal = document.getElementById('profileModal');
            if (event.target === modal) {
                modal.style.display = 'none';
            }
        }
        
        window.addEventListener('beforeunload', () => {
            if (currentUser.id) {
                socket.emit('user_offline', { id: currentUser.id });
            }
        });
        
        // ========== –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø ==========
        
        document.addEventListener('DOMContentLoaded', function() {
            console.log('üöÄ –ß–∞—Ç –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ—Ç—Å—è...');
            
            // –ó–∞–≥—Ä—É–∂–∞–µ–º –¥–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
            loadUserData();
            
            // –ó–∞–≥—Ä—É–∂–∞–µ–º —Å–æ–æ–±—â–µ–Ω–∏—è —á–µ—Ä–µ–∑ API
            loadMessages();
            
            // –ó–∞–≥—Ä—É–∂–∞–µ–º —Å–ø–∏—Å–æ–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π —á–µ—Ä–µ–∑ API
            setTimeout(() => {
                if (currentUser.role === 'admin') {
                    fetch('/api/admin/users?adminId=' + currentUser.id)
                        .then(res => res.json())
                        .then(data => {
                            if (data.success) {
                                updateOnlineUsers(data.users);
                            }
                        })
                        .catch(error => {
                            console.error('‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π:', error);
                        });
                }
            }, 2000);
            
            // –ü–µ—Ä–∏–æ–¥–∏—á–µ—Å–∫–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è
            setInterval(() => {
                if (!socket.connected) {
                    console.log('üîÑ –ü–æ–ø—ã—Ç–∫–∞ –ø–µ—Ä–µ–ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è WebSocket...');
                }
            }, 30000);
        });
    </script>
</body>
</html>
