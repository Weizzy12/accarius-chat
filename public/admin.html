<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–ê–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å</title>
    <link rel="stylesheet" href="style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
</head>
<body>
    <div class="admin-container">
        <div class="admin-header">
            <h1><i class="fas fa-crown"></i> –ê–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å</h1>
            <div>
                <a href="chat.html" class="btn btn-secondary">
                    <i class="fas fa-arrow-left"></i> –í–µ—Ä–Ω—É—Ç—å—Å—è –≤ —á–∞—Ç
                </a>
                <button onclick="logout()" class="btn btn-danger">
                    <i class="fas fa-sign-out-alt"></i> –í—ã–π—Ç–∏
                </button>
            </div>
        </div>
        
        <div class="admin-tabs">
            <button class="tab-btn active" onclick="openTab('codes')">
                <i class="fas fa-key"></i> –ò–Ω–≤–∞–π—Ç-–∫–æ–¥—ã
            </button>
            <button class="tab-btn" onclick="openTab('users')">
                <i class="fas fa-users"></i> –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏
            </button>
            <button class="tab-btn" onclick="openTab('stats')">
                <i class="fas fa-chart-bar"></i> –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞
            </button>
        </div>
        
        <!-- –í–∫–ª–∞–¥–∫–∞ –∫–æ–¥–æ–≤ -->
        <div id="codes" class="tab-content active">
            <div class="section-header">
                <h2><i class="fas fa-key"></i> –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∏–Ω–≤–∞–π—Ç-–∫–æ–¥–∞–º–∏</h2>
                <button onclick="generateCode()" class="btn btn-primary">
                    <i class="fas fa-plus"></i> –°–æ–∑–¥–∞—Ç—å –Ω–æ–≤—ã–π –∫–æ–¥
                </button>
            </div>
            
            <div id="newCodeAlert" class="alert alert-success" style="display: none;">
                <i class="fas fa-check-circle"></i> –ù–æ–≤—ã–π –∫–æ–¥ —Å–æ–∑–¥–∞–Ω: <strong id="newCodeValue"></strong>
                <button onclick="copyCode()" class="btn btn-secondary" style="margin-left: 10px; padding: 5px 10px;">
                    <i class="fas fa-copy"></i> –ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å
                </button>
            </div>
            
            <div class="table-container">
                <table class="data-table">
                    <thead>
                        <tr>
                            <th>–ö–æ–¥</th>
                            <th>–°–æ–∑–¥–∞–Ω</th>
                            <th>–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω</th>
                            <th>–ö–µ–º –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω</th>
                            <th>–°—Ç–∞—Ç—É—Å</th>
                            <th>–î–µ–π—Å—Ç–≤–∏—è</th>
                        </tr>
                    </thead>
                    <tbody id="codesTable">
                        <!-- –ö–æ–¥—ã –∑–∞–≥—Ä—É–∂–∞—é—Ç—Å—è –∑–¥–µ—Å—å -->
                    </tbody>
                </table>
            </div>
        </div>
        
        <!-- –í–∫–ª–∞–¥–∫–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π -->
        <div id="users" class="tab-content">
            <div class="section-header">
                <h2><i class="fas fa-users"></i> –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º–∏</h2>
                <div>
                    <input type="text" id="userSearch" placeholder="–ü–æ–∏—Å–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π..." class="form-input" 
                           style="width: 250px; margin-right: 10px;" onkeyup="searchUsers()">
                </div>
            </div>
            
            <div class="table-container">
                <table class="data-table">
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>–ò–º—è</th>
                            <th>Telegram</th>
                            <th>–†–æ–ª—å</th>
                            <th>–°–æ–æ–±—â–µ–Ω–∏–π</th>
                            <th>–î–∞—Ç–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏</th>
                            <th>–°—Ç–∞—Ç—É—Å</th>
                            <th>–î–µ–π—Å—Ç–≤–∏—è</th>
                        </tr>
                    </thead>
                    <tbody id="usersTable">
                        <!-- –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ –∑–∞–≥—Ä—É–∂–∞—é—Ç—Å—è –∑–¥–µ—Å—å -->
                    </tbody>
                </table>
            </div>
        </div>
        
        <!-- –í–∫–ª–∞–¥–∫–∞ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ -->
        <div id="stats" class="tab-content">
            <div class="section-header">
                <h2><i class="fas fa-chart-bar"></i> –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ —á–∞—Ç–∞</h2>
            </div>
            
            <div class="stats-grid">
                <div class="stat-card">
                    <h3>–í—Å–µ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π</h3>
                    <div class="stat-number" id="totalUsers">0</div>
                </div>
                <div class="stat-card">
                    <h3>–ê–∫—Ç–∏–≤–Ω—ã—Ö —Å–µ–≥–æ–¥–Ω—è</h3>
                    <div class="stat-number" id="activeToday">0</div>
                </div>
                <div class="stat-card">
                    <h3>–í—Å–µ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏–π</h3>
                    <div class="stat-number" id="totalMessages">0</div>
                </div>
                <div class="stat-card">
                    <h3>–°–æ–∑–¥–∞–Ω–æ –∫–æ–¥–æ–≤</h3>
                    <div class="stat-number" id="totalCodes">0</div>
                </div>
            </div>
            
            <div class="section-header" style="margin-top: 30px;">
                <h2><i class="fas fa-history"></i> –ü–æ—Å–ª–µ–¥–Ω—è—è –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—å</h2>
            </div>
            
            <div class="table-container">
                <table class="data-table">
                    <thead>
                        <tr>
                            <th>–í—Ä–µ–º—è</th>
                            <th>–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å</th>
                            <th>–î–µ–π—Å—Ç–≤–∏–µ</th>
                            <th>–î–µ—Ç–∞–ª–∏</th>
                        </tr>
                    </thead>
                    <tbody id="activityTable">
                        <!-- –ê–∫—Ç–∏–≤–Ω–æ—Å—Ç—å –∑–∞–≥—Ä—É–∂–∞–µ—Ç—Å—è –∑–¥–µ—Å—å -->
                    </tbody>
                </table>
            </div>
        </div>
    </div>
    
    <script>
        let currentAdminUser = null;
        let allUsers = [];
        let allCodes = [];
        
        // –ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö –∞–¥–º–∏–Ω–∞
        async function loadAdminData() {
            const response = await fetch('/api/user');
            const data = await response.json();
            
            if (data.success && data.user.role === 'admin') {
                currentAdminUser = data.user;
                loadAllData();
            } else {
                window.location.href = '/index.html';
            }
        }
        
        // –ó–∞–≥—Ä—É–∑–∫–∞ –≤—Å–µ—Ö –¥–∞–Ω–Ω—ã—Ö
        async function loadAllData() {
            await loadCodes();
            await loadUsers();
            await loadStats();
        }
        
        // –ó–∞–≥—Ä—É–∑–∫–∞ –∫–æ–¥–æ–≤
        async function loadCodes() {
            const response = await fetch('/api/admin/codes');
            const data = await response.json();
            
            if (data.success) {
                allCodes = data.codes;
                displayCodes(allCodes);
            }
        }
        
        // –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –∫–æ–¥–æ–≤ –≤ —Ç–∞–±–ª–∏—Ü–µ
        function displayCodes(codes) {
            const table = document.getElementById('codesTable');
            if (!table) return;
            
            table.innerHTML = '';
            
            codes.forEach(code => {
                const row = document.createElement('tr');
                
                // –û–ø—Ä–µ–¥–µ–ª—è–µ–º —Å—Ç–∞—Ç—É—Å
                let statusClass = 'status-inactive';
                let statusText = '–ù–µ–∞–∫—Ç–∏–≤–µ–Ω';
                
                if (code.is_active) {
                    if (code.used_by) {
                        statusClass = 'status-used';
                        statusText = '–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω';
                    } else {
                        statusClass = 'status-active';
                        statusText = '–ê–∫—Ç–∏–≤–µ–Ω';
                    }
                }
                
                // –§–æ—Ä–º–∞—Ç–∏—Ä—É–µ–º –¥–∞—Ç—ã
                const createdDate = new Date(code.created_at).toLocaleDateString('ru-RU');
                const usedDate = code.used_at ? new Date(code.used_at).toLocaleDateString('ru-RU') : '-';
                
                row.innerHTML = `
                    <td><strong>${code.code}</strong></td>
                    <td>${createdDate}</td>
                    <td>${usedDate}</td>
                    <td>${code.used_by_nickname || '-'}</td>
                    <td><span class="status-badge ${statusClass}">${statusText}</span></td>
                    <td class="actions">
                        ${code.is_active && !code.used_by ? 
                            `<button onclick="deactivateCode('${code.code}')" class="btn btn-danger" style="padding: 5px 10px;">
                                <i class="fas fa-times"></i> –û—Ç–æ–∑–≤–∞—Ç—å
                            </button>` : ''
                        }
                        ${code.used_by ? 
                            `<button onclick="viewUserProfile(${code.used_by})" class="btn btn-secondary" style="padding: 5px 10px;">
                                <i class="fas fa-eye"></i> –ü—Ä–æ—Ñ–∏–ª—å
                            </button>` : ''
                        }
                    </td>
                `;
                table.appendChild(row);
            });
        }
        
        // –ó–∞–≥—Ä—É–∑–∫–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
        async function loadUsers() {
            const response = await fetch('/api/admin/users');
            const data = await response.json();
            
            if (data.success) {
                allUsers = data.users;
                displayUsers(allUsers);
            }
        }
        
        // –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –≤ —Ç–∞–±–ª–∏—Ü–µ
        function displayUsers(users) {
            const table = document.getElementById('usersTable');
            if (!table) return;
            
            table.innerHTML = '';
            
            users.forEach(user => {
                const row = document.createElement('tr');
                
                // –°—Ç–∞—Ç—É—Å –±–∞–Ω–∞
                const isBanned = user.is_banned;
                const statusClass = isBanned ? 'status-used' : 'status-active';
                const statusText = isBanned ? '–ó–∞–±–∞–Ω–µ–Ω' : '–ê–∫—Ç–∏–≤–µ–Ω';
                
                // –†–æ–ª—å
                const roleBadge = user.role === 'admin' ? 
                    '<span class="status-badge status-active">üëë –ê–¥–º–∏–Ω</span>' : 
                    '<span class="status-badge status-inactive">üë§ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å</span>';
                
                row.innerHTML = `
                    <td>${user.id}</td>
                    <td>
                        <div style="display: flex; align-items: center; gap: 10px;">
                            <div class="user-avatar-small" style="background-color: ${user.avatar_color}">
                                ${user.nickname.charAt(0).toUpperCase()}
                            </div>
                            <strong>${user.nickname}</strong>
                        </div>
                    </td>
                    <td>${user.tg_username || '–ù–µ —É–∫–∞–∑–∞–Ω'}</td>
                    <td>${roleBadge}</td>
                    <td>${user.message_count || 0}</td>
                    <td>${new Date(user.created_at).toLocaleDateString('ru-RU')}</td>
                    <td><span class="status-badge ${statusClass}">${statusText}</span></td>
                    <td class="actions">
                        <button onclick="viewUserProfile(${user.id})" class="btn btn-secondary" style="padding: 5px 10px;">
                            <i class="fas fa-eye"></i>
                        </button>
                        ${user.id !== currentAdminUser.id ? `
                            <button onclick="toggleBanUser(${user.id}, ${isBanned})" class="btn ${isBanned ? 'btn-success' : 'btn-danger'}" style="padding: 5px 10px;">
                                <i class="fas ${isBanned ? 'fa-check' : 'fa-ban'}"></i>
                            </button>
                            ${user.role !== 'admin' ? `
                                <button onclick="makeAdminUser(${user.id})" class="btn btn-success" style="padding: 5px 10px;">
                                    <i class="fas fa-crown"></i>
                                </button>
                            ` : ''}
                        ` : ''}
                    </td>
                `;
                table.appendChild(row);
            });
        }
        
        // –ü–æ–∏—Å–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
        function searchUsers() {
            const searchTerm = document.getElementById('userSearch').value.toLowerCase();
            
            if (searchTerm === '') {
                displayUsers(allUsers);
                return;
            }
            
            const filteredUsers = allUsers.filter(user => 
                user.nickname.toLowerCase().includes(searchTerm) ||
                (user.tg_username && user.tg_username.toLowerCase().includes(searchTerm)) ||
                user.id.toString().includes(searchTerm)
            );
            
            displayUsers(filteredUsers);
        }
        
        // –ó–∞–≥—Ä—É–∑–∫–∞ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏
        async function loadStats() {
            // –û–±–Ω–æ–≤–ª—è–µ–º —Å—á–µ—Ç—á–∏–∫–∏
            document.getElementById('totalUsers').textContent = allUsers.length;
            document.getElementById('totalCodes').textContent = allCodes.length;
            
            // –°—á–∏—Ç–∞–µ–º –∞–∫—Ç–∏–≤–Ω—ã—Ö —Å–µ–≥–æ–¥–Ω—è
            const today = new Date().toDateString();
            const activeToday = allUsers.filter(user => {
                const userDate = new Date(user.created_at).toDateString();
                return userDate === today;
            }).length;
            
            document.getElementById('activeToday').textContent = activeToday;
            
            // –°—á–∏—Ç–∞–µ–º —Å–æ–æ–±—â–µ–Ω–∏—è
            const totalMessages = allUsers.reduce((sum, user) => sum + (user.message_count || 0), 0);
            document.getElementById('totalMessages').textContent = totalMessages;
            
            // –ó–∞–≥—Ä—É–∂–∞–µ–º –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—å (–ø–æ—Å–ª–µ–¥–Ω–∏–µ 10 —Å–æ–æ–±—â–µ–Ω–∏–π)
            const messagesResponse = await fetch('/api/messages');
            const messagesData = await messagesResponse.json();
            
            if (messagesData.success) {
                displayActivity(messagesData.messages.slice(-10).reverse());
            }
        }
        
        // –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏
        function displayActivity(messages) {
            const table = document.getElementById('activityTable');
            if (!table) return;
            
            table.innerHTML = '';
            
            messages.forEach(msg => {
                const row = document.createElement('tr');
                const time = new Date(msg.timestamp).toLocaleTimeString('ru-RU');
                
                row.innerHTML = `
                    <td>${time}</td>
                    <td>
                        <div style="display: flex; align-items: center; gap: 10px;">
                            <div class="user-avatar-small" style="background-color: ${msg.avatar_color}">
                                ${msg.nickname.charAt(0).toUpperCase()}
                            </div>
                            ${msg.nickname}
                        </div>
                    </td>
                    <td>–û—Ç–ø—Ä–∞–≤–∏–ª —Å–æ–æ–±—â–µ–Ω–∏–µ</td>
                    <td>${msg.text.length > 50 ? msg.text.substring(0, 50) + '...' : msg.text}</td>
                `;
                table.appendChild(row);
            });
        }
        
        // –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –Ω–æ–≤–æ–≥–æ –∫–æ–¥–∞
        async function generateCode() {
            const response = await fetch('/api/admin/generate-code', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' }
            });
            
            const data = await response.json();
            
            if (data.success) {
                // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ
                const alertDiv = document.getElementById('newCodeAlert');
                const codeSpan = document.getElementById('newCodeValue');
                
                codeSpan.textContent = data.code;
                alertDiv.style.display = 'block';
                
                // –û–±–Ω–æ–≤–ª—è–µ–º —Å–ø–∏—Å–æ–∫ –∫–æ–¥–æ–≤
                await loadCodes();
                
                // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Å–∫—Ä—ã–≤–∞–µ–º —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ —á–µ—Ä–µ–∑ 10 —Å–µ–∫—É–Ω–¥
                setTimeout(() => {
                    alertDiv.style.display = 'none';
                }, 10000);
            } else {
                alert('–û—à–∏–±–∫–∞: ' + data.message);
            }
        }
        
        // –ö–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ –∫–æ–¥–∞ –≤ –±—É—Ñ–µ—Ä –æ–±–º–µ–Ω–∞
        function copyCode() {
            const code = document.getElementById('newCodeValue').textContent;
            navigator.clipboard.writeText(code).then(() => {
                alert('–ö–æ–¥ —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω –≤ –±—É—Ñ–µ—Ä –æ–±–º–µ–Ω–∞!');
            });
        }
        
        // –î–µ–∞–∫—Ç–∏–≤–∞—Ü–∏—è –∫–æ–¥–∞
        async function deactivateCode(code) {
            if (!confirm('–û—Ç–æ–∑–≤–∞—Ç—å —ç—Ç–æ—Ç –∫–æ–¥? –ï–≥–æ –Ω–µ–ª—å–∑—è –±—É–¥–µ—Ç –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –¥–ª—è —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏.')) {
                return;
            }
            
            const response = await fetch('/api/admin/deactivate-code', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ code: code })
            });
            
            const data = await response.json();
            
            if (data.success) {
                alert('–ö–æ–¥ –æ—Ç–æ–∑–≤–∞–Ω');
                await loadCodes();
            } else {
                alert('–û—à–∏–±–∫–∞: ' + data.message);
            }
        }
        
        // –ü—Ä–æ—Å–º–æ—Ç—Ä –ø—Ä–æ—Ñ–∏–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        function viewUserProfile(userId) {
            window.location.href = `chat.html?profile=${userId}`;
        }
        
        // –ë–∞–Ω/—Ä–∞–∑–±–∞–Ω –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        async function toggleBanUser(userId, isBanned) {
            const action = isBanned ? 'unban' : 'ban';
            const confirmText = isBanned ? 
                '–†–∞–∑–±–∞–Ω–∏—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è?' : 
                '–ó–∞–±–∞–Ω–∏—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è?';
            
            if (!confirm(confirmText)) return;
            
            const response = await fetch('/api/admin/ban-user', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ userId: userId, action: action })
            });
            
            const data = await response.json();
            
            if (data.success) {
                alert(isBanned ? '–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Ä–∞–∑–±–∞–Ω–µ–Ω' : '–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∑–∞–±–∞–Ω–µ–Ω');
                await loadUsers();
            } else {
                alert('–û—à–∏–±–∫–∞: ' + data.message);
            }
        }
        
        // –ù–∞–∑–Ω–∞—á–∏—Ç—å –∞–¥–º–∏–Ω–æ–º
        async function makeAdminUser(userId) {
            if (!confirm('–°–¥–µ–ª–∞—Ç—å —ç—Ç–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–æ–º?')) return;
            
            const response = await fetch('/api/admin/ban-user', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ userId: userId, action: 'make_admin' })
            });
            
            const data = await response.json();
            
            if (data.success) {
                alert('–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Ç–µ–ø–µ—Ä—å –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä');
                await loadUsers();
            } else {
                alert('–û—à–∏–±–∫–∞: ' + data.message);
            }
        }
        
        // –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ –º–µ–∂–¥—É –≤–∫–ª–∞–¥–∫–∞–º–∏
        function openTab(tabName) {
            // –°–∫—Ä—ã–≤–∞–µ–º –≤—Å–µ –≤–∫–ª–∞–¥–∫–∏
            const tabContents = document.getElementsByClassName('tab-content');
            for (let i = 0; i < tabContents.length; i++) {
                tabContents[i].classList.remove('active');
            }
            
            // –£–±–∏—Ä–∞–µ–º –∞–∫—Ç–∏–≤–Ω—ã–π –∫–ª–∞—Å—Å —É –≤—Å–µ—Ö –∫–Ω–æ–ø–æ–∫
            const tabButtons = document.getElementsByClassName('tab-btn');
            for (let i = 0; i < tabButtons.length; i++) {
                tabButtons[i].classList.remove('active');
            }
            
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –≤—ã–±—Ä–∞–Ω–Ω—É—é –≤–∫–ª–∞–¥–∫—É
            document.getElementById(tabName).classList.add('active');
            
            // –î–æ–±–∞–≤–ª—è–µ–º –∞–∫—Ç–∏–≤–Ω—ã–π –∫–ª–∞—Å—Å –∫ –Ω–∞–∂–∞—Ç–æ–π –∫–Ω–æ–ø–∫–µ
            event.currentTarget.classList.add('active');
            
            // –û–±–Ω–æ–≤–ª—è–µ–º –¥–∞–Ω–Ω—ã–µ –Ω–∞ –≤–∫–ª–∞–¥–∫–µ
            if (tabName === 'stats') {
                loadStats();
            }
        }
        
        // –í—ã—Ö–æ–¥
        function logout() {
            localStorage.removeItem('user');
            window.location.href = '/index.html';
        }
        
        // –ê–≤—Ç–æ–∑–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö –∫–∞–∂–¥—ã–µ 30 —Å–µ–∫—É–Ω–¥
        setInterval(() => {
            if (document.querySelector('.tab-content.active').id === 'users') {
                loadUsers();
            }
        }, 30000);
        
        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
        document.addEventListener('DOMContentLoaded', function() {
            // –ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö –∞–¥–º–∏–Ω–∞ - –£–ü–†–û–©–Å–ù–ù–ê–Ø
async function loadAdminData() {
  try {
    const response = await fetch('/api/user');
    const data = await response.json();
    
    console.log('üëë –î–∞–Ω–Ω—ã–µ –∞–¥–º–∏–Ω–∞:', data);
    
    if (data.success) {
      currentAdminUser = data.user;
      loadAllData();
    } else {
      // –î–∞–∂–µ –µ—Å–ª–∏ –æ—à–∏–±–∫–∞ - –≤—Å—ë —Ä–∞–≤–Ω–æ –∑–∞–≥—Ä—É–∂–∞–µ–º
      currentAdminUser = {
        id: 1,
        nickname: '–ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä',
        role: 'admin'
      };
      loadAllData();
    }
  } catch (error) {
    console.error('‚ùå –û—à–∏–±–∫–∞ –∞–¥–º–∏–Ω–∫–∏:', error);
    
    // –ó–∞–ø–∞—Å–Ω–æ–π –≤–∞—Ä–∏–∞–Ω—Ç
    currentAdminUser = {
      id: 1,
      nickname: '–ê–¥–º–∏–Ω',
      role: 'admin'
    };
    loadAllData();
  }
}
