<script>
  // ========== –û–°–ù–û–í–ù–´–ï –ü–ï–†–ï–ú–ï–ù–ù–´–ï ==========
  let currentUser = {
    id: 1,
    nickname: '–ê–¥–º–∏–Ω',
    role: 'admin',
    avatar_color: '#3498db'
  };
  let selectedUserId = null;
  let onlineUsers = [];
  
  // ========== WebSocket ==========
  const socket = io(window.location.origin, {
    transports: ['websocket', 'polling'],
    reconnection: true
  });
  
  // ========== –°–ò–°–¢–ï–ú–ù–´–ï –§–£–ù–ö–¶–ò–ò ==========
  
  // 1. –ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
  async function loadUserData() {
    try {
      const response = await fetch('/api/user');
      const data = await response.json();
      
      if (data.success) {
        currentUser = data.user;
        console.log('‚úÖ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∑–∞–≥—Ä—É–∂–µ–Ω:', currentUser);
      } else {
        console.log('‚ö†Ô∏è –ò—Å–ø–æ–ª—å–∑—É–µ–º —Ç–µ—Å—Ç–æ–≤–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è');
      }
      
      // –í–°–ï–ì–î–ê –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –∫–Ω–æ–ø–∫—É –∞–¥–º–∏–Ω–∫–∏
      document.getElementById('adminBtn').style.display = 'block';
      updateCurrentUserDisplay();
      
    } catch (error) {
      console.error('‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è:', error);
      document.getElementById('adminBtn').style.display = 'block';
      updateCurrentUserDisplay();
    }
  }
  
  // 2. –û–±–Ω–æ–≤–∏—Ç—å –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ —Ç–µ–∫—É—â–µ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
  function updateCurrentUserDisplay() {
    const userDiv = document.getElementById('currentUser');
    if (userDiv) {
      userDiv.innerHTML = `
        <div class="user-avatar" style="background-color: ${currentUser.avatar_color}">
          ${currentUser.nickname.charAt(0).toUpperCase()}
        </div>
        <div class="user-info">
          <strong>${currentUser.nickname}</strong>
          <small>${currentUser.role === 'admin' ? 'üëë –ê–¥–º–∏–Ω' : 'üë§ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å'}</small>
        </div>
      `;
    }
  }
  
  // 3. –û—Ç–ø—Ä–∞–≤–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏—è
  function sendMessage() {
    const input = document.getElementById('messageInput');
    const text = input.value.trim();
    
    if (!text) {
      console.log('‚ö†Ô∏è –ü—É—Å—Ç–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ');
      return;
    }
    
    if (!socket.connected) {
      console.error('‚ùå WebSocket –Ω–µ –ø–æ–¥–∫–ª—é—á–µ–Ω!');
      alert('–ù–µ—Ç —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è! –û–±–Ω–æ–≤–∏ —Å—Ç—Ä–∞–Ω–∏—Ü—É.');
      return;
    }
    
    console.log('üì§ –û—Ç–ø—Ä–∞–≤–ª—è—é:', text);
    
    socket.emit('send_message', {
      userId: currentUser.id,
      text: text
    });
    
    input.value = '';
    input.focus();
  }
  
  // 4. –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ —Å–æ–æ–±—â–µ–Ω–∏–π
  function displayMessages(messages) {
    const container = document.getElementById('chatMessages');
    if (!container) return;
    
    container.innerHTML = '';
    
    messages.forEach(msg => {
      const messageDiv = document.createElement('div');
      messageDiv.className = 'message';
      messageDiv.innerHTML = `
        <div class="message-avatar" style="background-color: ${msg.avatar_color}"
             onclick="showProfile(${msg.user_id})">
          ${msg.nickname.charAt(0).toUpperCase()}
        </div>
        <div class="message-content">
          <div class="message-header">
            <strong class="message-sender" onclick="showProfile(${msg.user_id})">
              ${msg.nickname}
              ${msg.role === 'admin' ? 'üëë' : ''}
            </strong>
            <span class="message-time">${formatTime(msg.timestamp)}</span>
          </div>
          <div class="message-text">${msg.text}</div>
        </div>
      `;
      container.appendChild(messageDiv);
    });
    
    container.scrollTop = container.scrollHeight;
  }
  
  // ========== WebSocket –°–û–ë–´–¢–ò–Ø ==========
  
  socket.on('connect', () => {
    console.log('‚úÖ WebSocket –ø–æ–¥–∫–ª—é—á–µ–Ω!');
    socket.emit('get_history');
  });
  
  socket.on('message_history', (messages) => {
    console.log('üìú –ò—Å—Ç–æ—Ä–∏—è:', messages.length, '—Å–æ–æ–±—â–µ–Ω–∏–π');
    displayMessages(messages);
  });
  
  socket.on('new_message', (message) => {
    console.log('üì® –ù–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ:', message.text);
    
    const container = document.getElementById('chatMessages');
    if (!container) return;
    
    const messageDiv = document.createElement('div');
    messageDiv.className = 'message';
    messageDiv.innerHTML = `
      <div class="message-avatar" style="background-color: ${message.user.avatar_color}"
           onclick="showProfile(${message.user.id})">
        ${message.user.nickname.charAt(0).toUpperCase()}
      </div>
      <div class="message-content">
        <div class="message-header">
          <strong class="message-sender" onclick="showProfile(${message.user.id})">
            ${message.user.nickname}
            ${message.user.role === 'admin' ? 'üëë' : ''}
          </strong>
          <span class="message-time">${formatTime(message.timestamp)}</span>
        </div>
        <div class="message-text">${message.text}</div>
      </div>
    `;
    container.appendChild(messageDiv);
    container.scrollTop = container.scrollHeight;
  });
  
  socket.on('error', (data) => {
    console.error('‚ùå WebSocket –æ—à–∏–±–∫–∞:', data);
  });
  
  socket.on('disconnect', () => {
    console.log('‚ùå WebSocket –æ—Ç–∫–ª—é—á–µ–Ω');
  });
  
  // ========== –í–°–ü–û–ú–û–ì–ê–¢–ï–õ–¨–ù–´–ï –§–£–ù–ö–¶–ò–ò ==========
  
  function formatTime(timestamp) {
    const date = new Date(timestamp);
    return date.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
  }
  
  function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
  }
  
  // ========== –ê–î–ú–ò–ù –§–£–ù–ö–¶–ò–ò (—É–ø—Ä–æ—â—ë–Ω–Ω—ã–µ) ==========
  
  function showProfile(userId) {
    alert('–ü—Ä–æ—Ñ–∏–ª—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è ID: ' + userId);
  }
  
  async function banUser() {
    alert('–ë–∞–Ω –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è');
  }
  
  async function muteUser() {
    alert('–ú—É—Ç –Ω–∞ 5 –º–∏–Ω—É—Ç');
  }
  
  async function makeAdmin() {
    alert('–°–¥–µ–ª–∞—Ç—å –∞–¥–º–∏–Ω–æ–º');
  }
  
  function closeProfile() {
    const modal = document.getElementById('profileModal');
    if (modal) {
      modal.style.display = 'none';
    }
  }
  
  // ========== –ö–õ–ê–í–ò–ê–¢–£–†–ê ==========
  
  document.getElementById('messageInput')?.addEventListener('keypress', function(e) {
    if (e.key === 'Enter') sendMessage();
  });
  
  // ========== –ó–ê–ì–†–£–ó–ö–ê –°–¢–†–ê–ù–ò–¶–´ ==========
  
  document.addEventListener('DOMContentLoaded', function() {
    console.log('üöÄ –ß–∞—Ç –∑–∞–≥—Ä—É–∂–∞–µ—Ç—Å—è...');
    loadUserData();
    
    // –¢–µ—Å—Ç–æ–≤–∞—è –∫–Ω–æ–ø–∫–∞
    const testBtn = document.createElement('button');
    testBtn.className = 'btn btn-success';
    testBtn.innerHTML = '<i class="fas fa-bolt"></i> –¢–µ—Å—Ç —Å–æ–æ–±—â–µ–Ω–∏—è';
    testBtn.onclick = () => {
      socket.emit('send_message', {
        userId: 999,
        text: '–¢–µ—Å—Ç–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ ' + new Date().toLocaleTimeString()
      });
    };
    
    const header = document.querySelector('.chat-info');
    if (header) {
      header.appendChild(testBtn);
    }
  });
</script>
