<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–ü—Ä–∏–≤–∞—Ç–Ω—ã–π –ß–∞—Ç</title>
    <link rel="stylesheet" href="style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
</head>
<body>
    <div class="chat-container">
        <!-- –ë–æ–∫–æ–≤–∞—è –ø–∞–Ω–µ–ª—å —Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º–∏ -->
        <div class="sidebar">
            <div class="sidebar-header">
                <h3><i class="fas fa-users"></i> –û–Ω–ª–∞–π–Ω</h3>
                <span id="onlineCount">0</span>
            </div>
            <div id="usersList" class="users-list"></div>
            
            <div class="sidebar-footer">
                <div id="currentUser" class="current-user"></div>
                <button onclick="window.location.href='/admin.html'" id="adminBtn" style="display: none;">
                    <i class="fas fa-cog"></i> –ê–¥–º–∏–Ω–∫–∞
                </button>
            </div>
        </div>
        
        <!-- –û—Å–Ω–æ–≤–Ω–∞—è –æ–±–ª–∞—Å—Ç—å —á–∞—Ç–∞ -->
        <div class="chat-main">
            <!-- –ó–∞–≥–æ–ª–æ–≤–æ–∫ —á–∞—Ç–∞ -->
            <div class="chat-header">
                <h2><i class="fas fa-comments"></i> –û–±—â–∏–π —á–∞—Ç</h2>
                <div class="chat-info">
                    <span id="messageCount">0 —Å–æ–æ–±—â–µ–Ω–∏–π</span>
                </div>
            </div>
            
            <!-- –û–∫–Ω–æ —Å–æ–æ–±—â–µ–Ω–∏–π -->
            <div class="chat-messages" id="chatMessages">
                <!-- –°–æ–æ–±—â–µ–Ω–∏—è –∑–∞–≥—Ä—É–∂–∞—é—Ç—Å—è –∑–¥–µ—Å—å -->
            </div>
            
            <!-- –ü–∞–Ω–µ–ª—å –≤–≤–æ–¥–∞ -->
            <div class="chat-input-container">
                <input type="text" id="messageInput" placeholder="–ù–∞–ø–∏—à–∏—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏–µ..." class="message-input">
                <button onclick="sendMessage()" class="send-btn">
                    <i class="fas fa-paper-plane"></i>
                </button>
            </div>
        </div>
        
        <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –ø—Ä–æ—Ñ–∏–ª—è -->
        <div id="profileModal" class="modal">
            <div class="modal-content">
                <span class="close" onclick="closeProfile()">&times;</span>
                <div id="profileContent"></div>
                <div id="adminActions" style="display: none; margin-top: 20px;">
                    <h4>–î–µ–π—Å—Ç–≤–∏—è –∞–¥–º–∏–Ω–∞:</h4>
                    <button onclick="banUser()" class="btn btn-danger">
                        <i class="fas fa-ban"></i> –ó–∞–±–∞–Ω–∏—Ç—å
                    </button>
                    <button onclick="muteUser()" class="btn btn-warning">
                        <i class="fas fa-volume-mute"></i> –ú—É—Ç –Ω–∞ 5 –º–∏–Ω
                    </button>
                    <button onclick="makeAdmin()" class="btn btn-success">
                        <i class="fas fa-crown"></i> –°–¥–µ–ª–∞—Ç—å –∞–¥–º–∏–Ω–æ–º
                    </button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- –ü–æ–¥–∫–ª—é—á–∞–µ–º Socket.io –∫–ª–∏–µ–Ω—Ç -->
    <script src="/socket.io/socket.io.js"></script>
    <script>
        // –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ WebSocket
        const socket = io();
        let currentUser = JSON.parse(localStorage.getItem('user') || '{}');
        let selectedUserId = null;
        let onlineUsers = [];
        
        // –ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        async function loadUserData() {
            const response = await fetch('/api/user');
            const data = await response.json();
            
            if (data.success) {
                currentUser = data.user;
                localStorage.setItem('user', JSON.stringify(data.user));
                updateCurrentUserDisplay();
                
                // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∫–Ω–æ–ø–∫—É –∞–¥–º–∏–Ω–∫–∏ –µ—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∞–¥–º–∏–Ω
                if (currentUser.role === 'admin') {
                    document.getElementById('adminBtn').style.display = 'block';
                }
                
                // –°–æ–æ–±—â–∞–µ–º —Å–µ—Ä–≤–µ—Ä—É –æ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–∏
                socket.emit('user_online', {
                    id: currentUser.id,
                    nickname: currentUser.nickname,
                    avatar_color: currentUser.avatar_color
                });
            } else {
                // –ï—Å–ª–∏ –Ω–µ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω, –≤–æ–∑–≤—Ä–∞—â–∞–µ–º –Ω–∞ –≤—Ö–æ–¥
                window.location.href = '/index.html';
            }
        }
        
        // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è —Ç–µ–∫—É—â–µ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        function updateCurrentUserDisplay() {
            const userDiv = document.getElementById('currentUser');
            if (userDiv) {
                userDiv.innerHTML = `
                    <div class="user-avatar" style="background-color: ${currentUser.avatar_color}">
                        ${currentUser.nickname.charAt(0).toUpperCase()}
                    </div>
                    <div class="user-info">
                        <strong>${currentUser.nickname}</strong>
                        <small>${currentUser.role === 'admin' ? 'üëë –ê–¥–º–∏–Ω' : 'üë§ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å'}</small>
                    </div>
                `;
            }
        }
        
        // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å–ø–∏—Å–∫–∞ –æ–Ω–ª–∞–π–Ω –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
        function updateOnlineUsers(users) {
            onlineUsers = users;
            const usersList = document.getElementById('usersList');
            const onlineCount = document.getElementById('onlineCount');
            
            if (usersList && onlineCount) {
                usersList.innerHTML = '';
                onlineCount.textContent = users.length;
                
                users.forEach(user => {
                    const userDiv = document.createElement('div');
                    userDiv.className = 'online-user';
                    userDiv.onclick = () => showProfile(user.id);
                    userDiv.innerHTML = `
                        <div class="user-avatar-small" style="background-color: ${user.avatar_color}">
                            ${user.nickname.charAt(0).toUpperCase()}
                        </div>
                        <div class="user-details">
                            <strong>${user.nickname}</strong>
                            ${user.role === 'admin' ? '<small>üëë</small>' : ''}
                        </div>
                    `;
                    usersList.appendChild(userDiv);
                });
            }
        }
        
        // –û—Ç–ø—Ä–∞–≤–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏—è
        function sendMessage() {
            const input = document.getElementById('messageInput');
            const text = input.value.trim();
            
            if (!text || !currentUser.id) return;
            
            socket.emit('send_message', {
                userId: currentUser.id,
                text: text
            });
            
            input.value = '';
            input.focus();
        }
        
        // –ó–∞–≥—Ä—É–∑–∫–∞ –∏—Å—Ç–æ—Ä–∏–∏ —Å–æ–æ–±—â–µ–Ω–∏–π
        async function loadMessages() {
            const response = await fetch('/api/messages');
            const data = await response.json();
            
            if (data.success) {
                displayMessages(data.messages);
                document.getElementById('messageCount').textContent = 
                    `${data.messages.length} —Å–æ–æ–±—â–µ–Ω–∏–π`;
            }
        }
        
        // –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ —Å–æ–æ–±—â–µ–Ω–∏–π
        function displayMessages(messages) {
            const container = document.getElementById('chatMessages');
            if (!container) return;
            
            container.innerHTML = '';
            
            messages.forEach(msg => {
                const messageDiv = document.createElement('div');
                messageDiv.className = 'message';
                messageDiv.innerHTML = `
                    <div class="message-avatar" style="background-color: ${msg.avatar_color}"
                         onclick="showProfile(${msg.user_id})">
                        ${msg.nickname.charAt(0).toUpperCase()}
                    </div>
                    <div class="message-content">
                        <div class="message-header">
                            <strong class="message-sender" onclick="showProfile(${msg.user_id})">
                                ${msg.nickname}
                                ${msg.role === 'admin' ? 'üëë' : ''}
                            </strong>
                            <span class="message-time">${formatTime(msg.timestamp)}</span>
                        </div>
                        <div class="message-text">${escapeHtml(msg.text)}</div>
                    </div>
                `;
                container.appendChild(messageDiv);
            });
            
            // –ü—Ä–æ–∫—Ä—É—Ç–∫–∞ –≤–Ω–∏–∑
            container.scrollTop = container.scrollHeight;
        }
        
        // –ü–æ–∫–∞–∑–∞—Ç—å –ø—Ä–æ—Ñ–∏–ª—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        function showProfile(userId) {
            selectedUserId = userId;
            const modal = document.getElementById('profileModal');
            const adminActions = document.getElementById('adminActions');
            
            // –ó–∞–≥—Ä—É–∂–∞–µ–º –¥–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
            fetch(`/api/admin/users`)
                .then(res => res.json())
                .then(data => {
                    if (data.success) {
                        const user = data.users.find(u => u.id === userId);
                        if (user) {
                            document.getElementById('profileContent').innerHTML = `
                                <div style="text-align: center;">
                                    <div class="profile-avatar" style="background-color: ${user.avatar_color}; 
                                         margin: 0 auto 15px; width: 80px; height: 80px; font-size: 32px; 
                                         display: flex; align-items: center; justify-content: center; 
                                         border-radius: 50%; color: white; font-weight: bold;">
                                        ${user.nickname.charAt(0).toUpperCase()}
                                    </div>
                                    <h3>${user.nickname}</h3>
                                    <p><strong>Telegram:</strong> ${user.tg_username || '–ù–µ —É–∫–∞–∑–∞–Ω'}</p>
                                    <p><strong>–†–æ–ª—å:</strong> ${user.role === 'admin' ? 'üëë –ê–¥–º–∏–Ω' : 'üë§ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å'}</p>
                                    <p><strong>–°–æ–æ–±—â–µ–Ω–∏–π:</strong> ${user.message_count}</p>
                                    <p><strong>–ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω:</strong> ${new Date(user.created_at).toLocaleDateString()}</p>
                                    <p><strong>–°—Ç–∞—Ç—É—Å:</strong> ${user.is_banned ? '‚ùå –ó–∞–±–∞–Ω–µ–Ω' : '‚úÖ –ê–∫—Ç–∏–≤–µ–Ω'}</p>
                                </div>
                            `;
                            
                            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∫–Ω–æ–ø–∫–∏ –∞–¥–º–∏–Ω–∞ —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ —Ç–µ–∫—É—â–∏–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∞–¥–º–∏–Ω
                            if (currentUser.role === 'admin' && user.id !== currentUser.id) {
                                adminActions.style.display = 'block';
                            } else {
                                adminActions.style.display = 'none';
                            }
                            
                            modal.style.display = 'block';
                        }
                    }
                });
        }
        
        // –ó–∞–∫—Ä—ã—Ç—å –ø—Ä–æ—Ñ–∏–ª—å
        function closeProfile() {
            const modal = document.getElementById('profileModal');
            if (modal) {
                modal.style.display = 'none';
            }
        }
        
        // –î–µ–π—Å—Ç–≤–∏—è –∞–¥–º–∏–Ω–∞
        async function banUser() {
            if (!selectedUserId) return;
            if (!confirm('–ó–∞–±–∞–Ω–∏—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è?')) return;
            
            const response = await fetch('/api/admin/ban-user', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ userId: selectedUserId, action: 'ban' })
            });
            
            const data = await response.json();
            if (data.success) {
                alert('–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∑–∞–±–∞–Ω–µ–Ω');
                closeProfile();
            }
        }
        
        async function muteUser() {
            if (!selectedUserId) return;
            
            // –†–µ–∞–ª–∏–∑—É–µ–º –º—É—Ç –Ω–∞ –∫–ª–∏–µ–Ω—Ç–µ (–≤ —Ä–µ–∞–ª—å–Ω–æ—Å—Ç–∏ –Ω—É–∂–Ω–æ –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ)
            const muteDuration = 5 * 60 * 1000; // 5 –º–∏–Ω—É—Ç
            const muteKey = `muted_${selectedUserId}`;
            localStorage.setItem(muteKey, Date.now() + muteDuration);
            
            alert('–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∑–∞–º—å—é—á–µ–Ω –Ω–∞ 5 –º–∏–Ω—É—Ç');
            closeProfile();
        }
        
        async function makeAdmin() {
            if (!selectedUserId) return;
            if (!confirm('–°–¥–µ–ª–∞—Ç—å —ç—Ç–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∞–¥–º–∏–Ω–æ–º?')) return;
            
            const response = await fetch('/api/admin/ban-user', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ userId: selectedUserId, action: 'make_admin' })
            });
            
            const data = await response.json();
            if (data.success) {
                alert('–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Ç–µ–ø–µ—Ä—å –∞–¥–º–∏–Ω');
                closeProfile();
            }
        }
        
        // –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏
        function formatTime(timestamp) {
            const date = new Date(timestamp);
            return date.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
        }
        
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }
        
        // –ù–∞–∂–∞—Ç–∏–µ Enter –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏
        document.getElementById('messageInput')?.addEventListener('keypress', function(e) {
            if (e.key === 'Enter') sendMessage();
        });
        
        // –ó–∞–∫—Ä—ã—Ç—å –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –ø—Ä–∏ –∫–ª–∏–∫–µ –≤–Ω–µ –µ–≥–æ
        window.onclick = function(event) {
            const modal = document.getElementById('profileModal');
            if (event.target === modal) {
                modal.style.display = 'none';
            }
        }
        
        // ========== WebSocket —Å–æ–±—ã—Ç–∏—è ==========
        
        // –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ —Å–æ–∫–µ—Ç—É
        socket.on('connect', () => {
            console.log('–ü–æ–¥–∫–ª—é—á–µ–Ω –∫ —á–∞—Ç—É');
            socket.emit('get_history');
            
            // –ï—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω, —Å–æ–æ–±—â–∞–µ–º –æ –µ–≥–æ –æ–Ω–ª–∞–π–Ω-—Å—Ç–∞—Ç—É—Å–µ
            if (currentUser.id) {
                socket.emit('user_online', {
                    id: currentUser.id,
                    nickname: currentUser.nickname,
                    avatar_color: currentUser.avatar_color
                });
            }
        });
        
        // –ü–æ–ª—É—á–µ–Ω–∏–µ –∏—Å—Ç–æ—Ä–∏–∏ —Å–æ–æ–±—â–µ–Ω–∏–π
        socket.on('message_history', (messages) => {
            displayMessages(messages);
        });
        
        // –ù–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ
        socket.on('new_message', (message) => {
            const messagesContainer = document.getElementById('chatMessages');
            if (!messagesContainer) return;
            
            const messageDiv = document.createElement('div');
            messageDiv.className = 'message';
            messageDiv.innerHTML = `
                <div class="message-avatar" style="background-color: ${message.user.avatar_color}"
                     onclick="showProfile(${message.user.id})">
                    ${message.user.nickname.charAt(0).toUpperCase()}
                </div>
                <div class="message-content">
                    <div class="message-header">
                        <strong class="message-sender" onclick="showProfile(${message.user.id})">
                            ${message.user.nickname}
                            ${message.user.role === 'admin' ? 'üëë' : ''}
                        </strong>
                        <span class="message-time">${formatTime(message.timestamp)}</span>
                    </div>
                    <div class="message-text">${escapeHtml(message.text)}</div>
                </div>
            `;
            messagesContainer.appendChild(messageDiv);
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
            
            // –û–±–Ω–æ–≤–ª—è–µ–º —Å—á–µ—Ç—á–∏–∫ —Å–æ–æ–±—â–µ–Ω–∏–π
            const messageCount = document.getElementById('messageCount');
            if (messageCount) {
                const current = parseInt(messageCount.textContent) || 0;
                messageCount.textContent = `${current + 1} —Å–æ–æ–±—â–µ–Ω–∏–π`;
            }
        });
        
        // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å–ø–∏—Å–∫–∞ –æ–Ω–ª–∞–π–Ω –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
        socket.on('update_online_users', (users) => {
            updateOnlineUsers(users);
        });
        
        // –î–µ–π—Å—Ç–≤–∏–µ –∞–¥–º–∏–Ω–∞ (–±–∞–Ω –∏ —Ç.–¥.)
        socket.on('admin_action', (data) => {
            if (data.userId === currentUser.id && data.action === 'ban') {
                alert('–í—ã –±—ã–ª–∏ –∑–∞–±–∞–Ω–µ–Ω—ã!');
                window.location.href = '/index.html';
            }
        });
        
        // –û—à–∏–±–∫–∞
        socket.on('error', (data) => {
            alert('–û—à–∏–±–∫–∞: ' + data.message);
        });
        
        // –û—Ç–∫–ª—é—á–µ–Ω–∏–µ –æ—Ç —Å–µ—Ä–≤–µ—Ä–∞
        socket.on('disconnect', () => {
            console.log('–û—Ç–∫–ª—é—á–µ–Ω –æ—Ç —á–∞—Ç–∞');
        });
        
        // –ü–µ—Ä–µ–¥ –∑–∞–∫—Ä—ã—Ç–∏–µ–º —Å—Ç—Ä–∞–Ω–∏—Ü—ã —Å–æ–æ–±—â–∞–µ–º –æ –≤—ã—Ö–æ–¥–µ
        window.addEventListener('beforeunload', () => {
            if (currentUser.id) {
                socket.emit('user_offline', { id: currentUser.id });
            }
        });
        
        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
        document.addEventListener('DOMContentLoaded', function() {
            loadUserData();
            loadMessages();
            
            // –ó–∞–≥—Ä—É–∂–∞–µ–º —Å–ø–∏—Å–æ–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
            setTimeout(() => {
                fetch('/api/admin/users')
                    .then(res => res.json())
                    .then(data => {
                        if (data.success) {
                            updateOnlineUsers(data.users);
                        }
                    });
            }, 1000);
        });
    </script>
</body>
</html>