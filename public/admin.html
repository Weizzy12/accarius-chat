<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–ê–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å</title>
    <link rel="stylesheet" href="style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
</head>
<body>
    <div class="admin-container">
        <div class="admin-header">
            <h1><i class="fas fa-crown"></i> –ê–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å</h1>
            <div>
                <a href="chat.html" class="btn btn-secondary">
                    <i class="fas fa-arrow-left"></i> –í–µ—Ä–Ω—É—Ç—å—Å—è –≤ —á–∞—Ç
                </a>
                <button onclick="logout()" class="btn btn-danger">
                    <i class="fas fa-sign-out-alt"></i> –í—ã–π—Ç–∏
                </button>
            </div>
        </div>
        
        <div class="admin-tabs">
            <button class="tab-btn active" onclick="openTab('codes')">
                <i class="fas fa-key"></i> –ò–Ω–≤–∞–π—Ç-–∫–æ–¥—ã
            </button>
            <button class="tab-btn" onclick="openTab('users')">
                <i class="fas fa-users"></i> –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏
            </button>
            <button class="tab-btn" onclick="openTab('stats')">
                <i class="fas fa-chart-bar"></i> –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞
            </button>
        </div>
        
        <!-- –í–∫–ª–∞–¥–∫–∞ –∫–æ–¥–æ–≤ -->
        <div id="codes" class="tab-content active">
            <div class="section-header">
                <h2><i class="fas fa-key"></i> –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∏–Ω–≤–∞–π—Ç-–∫–æ–¥–∞–º–∏</h2>
                <button onclick="generateCode()" class="btn btn-primary">
                    <i class="fas fa-plus"></i> –°–æ–∑–¥–∞—Ç—å –Ω–æ–≤—ã–π –∫–æ–¥
                </button>
            </div>
            
            <div id="newCodeAlert" class="alert alert-success" style="display: none; background: #c6f6d5; color: #22543d; padding: 12px; border-radius: 8px; margin-bottom: 20px;">
                <i class="fas fa-check-circle"></i> –ù–æ–≤—ã–π –∫–æ–¥ —Å–æ–∑–¥–∞–Ω: <strong id="newCodeValue"></strong>
                <button onclick="copyCode()" class="btn btn-secondary" style="margin-left: 10px; padding: 5px 10px;">
                    <i class="fas fa-copy"></i> –ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å
                </button>
            </div>
            
            <div class="table-container">
                <table class="data-table">
                    <thead>
                        <tr>
                            <th>–ö–æ–¥</th>
                            <th>–°–æ–∑–¥–∞–Ω</th>
                            <th>–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω</th>
                            <th>–ö–µ–º –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω</th>
                            <th>–°—Ç–∞—Ç—É—Å</th>
                            <th>–î–µ–π—Å—Ç–≤–∏—è</th>
                        </tr>
                    </thead>
                    <tbody id="codesTable">
                        <!-- –ö–æ–¥—ã –∑–∞–≥—Ä—É–∂–∞—é—Ç—Å—è –∑–¥–µ—Å—å -->
                    </tbody>
                </table>
            </div>
        </div>
        
        <!-- –í–∫–ª–∞–¥–∫–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π -->
        <div id="users" class="tab-content">
            <div class="section-header">
                <h2><i class="fas fa-users"></i> –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º–∏</h2>
                <div>
                    <input type="text" id="userSearch" placeholder="–ü–æ–∏—Å–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π..." class="form-input" 
                           style="width: 250px; margin-right: 10px;" onkeyup="searchUsers()">
                </div>
            </div>
            
            <div class="table-container">
                <table class="data-table">
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>–ò–º—è</th>
                            <th>Telegram</th>
                            <th>–†–æ–ª—å</th>
                            <th>–°–æ–æ–±—â–µ–Ω–∏–π</th>
                            <th>–î–∞—Ç–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏</th>
                            <th>–°—Ç–∞—Ç—É—Å</th>
                            <th>–î–µ–π—Å—Ç–≤–∏—è</th>
                        </tr>
                    </thead>
                    <tbody id="usersTable">
                        <!-- –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ –∑–∞–≥—Ä—É–∂–∞—é—Ç—Å—è –∑–¥–µ—Å—å -->
                    </tbody>
                </table>
            </div>
        </div>
        
        <!-- –í–∫–ª–∞–¥–∫–∞ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ -->
        <div id="stats" class="tab-content">
            <div class="section-header">
                <h2><i class="fas fa-chart-bar"></i> –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ —á–∞—Ç–∞</h2>
            </div>
            
            <div class="stats-grid">
                <div class="stat-card">
                    <h3>–í—Å–µ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π</h3>
                    <div class="stat-number" id="totalUsers">0</div>
                </div>
                <div class="stat-card">
                    <h3>–ê–∫—Ç–∏–≤–Ω—ã—Ö —Å–µ–≥–æ–¥–Ω—è</h3>
                    <div class="stat-number" id="activeToday">0</div>
                </div>
                <div class="stat-card">
                    <h3>–í—Å–µ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏–π</h3>
                    <div class="stat-number" id="totalMessages">0</div>
                </div>
                <div class="stat-card">
                    <h3>–°–æ–∑–¥–∞–Ω–æ –∫–æ–¥–æ–≤</h3>
                    <div class="stat-number" id="totalCodes">0</div>
                </div>
            </div>
            
            <div class="section-header" style="margin-top: 30px;">
                <h2><i class="fas fa-history"></i> –ü–æ—Å–ª–µ–¥–Ω—è—è –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—å</h2>
            </div>
            
            <div class="table-container">
                <table class="data-table">
                    <thead>
                        <tr>
                            <th>–í—Ä–µ–º—è</th>
                            <th>–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å</th>
                            <th>–î–µ–π—Å—Ç–≤–∏–µ</th>
                            <th>–î–µ—Ç–∞–ª–∏</th>
                        </tr>
                    </thead>
                    <tbody id="activityTable">
                        <tr>
                            <td>12:30</td>
                            <td>–ê–¥–º–∏–Ω</td>
                            <td>–í–æ—à–µ–ª –≤ —Å–∏—Å—Ç–µ–º—É</td>
                            <td>–í—Ö–æ–¥ –≤ –∞–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>
    
    <script>
        // ========== –ü–ï–†–ï–ú–ï–ù–ù–´–ï ==========
        let currentAdminUser = {
            id: 1,
            nickname: '–ê–¥–º–∏–Ω',
            role: 'admin'
        };
        let allUsers = [];
        let allCodes = [];
        
        // ========== –û–°–ù–û–í–ù–´–ï –§–£–ù–ö–¶–ò–ò ==========
        
        // 1. –ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö –∞–¥–º–∏–Ω–∞
        async function loadAdminData() {
            console.log('üëë –ó–∞–≥—Ä—É–∂–∞–µ–º –∞–¥–º–∏–Ω–∫—É...');
            
            // –í–°–ï–ì–î–ê –∞–¥–º–∏–Ω
            currentAdminUser = {
                id: 1,
                nickname: '–ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä',
                role: 'admin'
            };
            
            // –ó–∞–≥—Ä—É–∂–∞–µ–º –≤—Å—ë
            await loadCodes();
            await loadUsers();
            await loadStats();
            
            console.log('‚úÖ –ê–¥–º–∏–Ω–∫–∞ –≥–æ—Ç–æ–≤–∞');
        }
        
        // 2. –ó–∞–≥—Ä—É–∑–∫–∞ –∫–æ–¥–æ–≤
        async function loadCodes() {
            try {
                const response = await fetch('/api/admin/codes');
                const data = await response.json();
                
                if (data.success) {
                    allCodes = data.codes;
                    displayCodes(allCodes);
                }
            } catch (error) {
                console.error('‚ùå –û—à–∏–±–∫–∞ –∫–æ–¥–æ–≤:', error);
                displayCodes([]);
            }
        }
        
        // 3. –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –∫–æ–¥–æ–≤
        function displayCodes(codes) {
            const table = document.getElementById('codesTable');
            if (!table) return;
            
            table.innerHTML = '';
            
            codes.forEach(code => {
                const row = document.createElement('tr');
                
                const statusClass = code.is_active ? 'status-active' : 'status-inactive';
                const statusText = code.is_active ? '–ê–∫—Ç–∏–≤–µ–Ω' : '–ù–µ–∞–∫—Ç–∏–≤–µ–Ω';
                
                row.innerHTML = `
                    <td><strong>${code.code}</strong></td>
                    <td>${new Date(code.created_at).toLocaleDateString()}</td>
                    <td>${code.used_by_nickname || '-'}</td>
                    <td>${code.used_by_nickname || '–ù–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω'}</td>
                    <td><span class="status-badge ${statusClass}">${statusText}</span></td>
                    <td>
                        <button onclick="deactivateCode('${code.code}')" class="btn btn-danger btn-small">
                            <i class="fas fa-times"></i> –û—Ç–æ–∑–≤–∞—Ç—å
                        </button>
                    </td>
                `;
                table.appendChild(row);
            });
        }
        
        // 4. –ó–∞–≥—Ä—É–∑–∫–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
        async function loadUsers() {
            try {
                const response = await fetch('/api/admin/users');
                const data = await response.json();
                
                if (data.success) {
                    allUsers = data.users;
                    displayUsers(allUsers);
                }
            } catch (error) {
                console.error('‚ùå –û—à–∏–±–∫–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π:', error);
                displayUsers([]);
            }
        }
        
        // 5. –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
        function displayUsers(users) {
            const table = document.getElementById('usersTable');
            if (!table) return;
            
            table.innerHTML = '';
            
            users.forEach(user => {
                const row = document.createElement('tr');
                
                const roleBadge = user.role === 'admin' 
                    ? '<span class="status-badge status-active">üëë –ê–¥–º–∏–Ω</span>'
                    : '<span class="status-badge status-inactive">üë§ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å</span>';
                
                row.innerHTML = `
                    <td>${user.id}</td>
                    <td>
                        <div style="display: flex; align-items: center; gap: 10px;">
                            <div class="user-avatar-small" style="background-color: ${user.avatar_color}">
                                ${user.nickname.charAt(0).toUpperCase()}
                            </div>
                            <strong>${user.nickname}</strong>
                        </div>
                    </td>
                    <td>${user.tg_username || '–ù–µ —É–∫–∞–∑–∞–Ω'}</td>
                    <td>${roleBadge}</td>
                    <td>${user.message_count || 0}</td>
                    <td>${new Date(user.created_at).toLocaleDateString()}</td>
                    <td>${user.is_banned ? '‚ùå –ó–∞–±–∞–Ω–µ–Ω' : '‚úÖ –ê–∫—Ç–∏–≤–µ–Ω'}</td>
                    <td>
                        <button onclick="toggleBanUser(${user.id}, ${user.is_banned})" 
                                class="btn ${user.is_banned ? 'btn-success' : 'btn-danger'} btn-small">
                            <i class="fas ${user.is_banned ? 'fa-check' : 'fa-ban'}"></i>
                            ${user.is_banned ? '–†–∞–∑–±–∞–Ω–∏—Ç—å' : '–ó–∞–±–∞–Ω–∏—Ç—å'}
                        </button>
                        ${user.role !== 'admin' ? `
                            <button onclick="makeAdminUser(${user.id})" class="btn btn-success btn-small">
                                <i class="fas fa-crown"></i> –ê–¥–º–∏–Ω
                            </button>
                        ` : ''}
                    </td>
                `;
                table.appendChild(row);
            });
        }
        
        // 6. –ü–æ–∏—Å–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
        function searchUsers() {
            const searchTerm = document.getElementById('userSearch').value.toLowerCase();
            
            if (searchTerm === '') {
                displayUsers(allUsers);
                return;
            }
            
            const filteredUsers = allUsers.filter(user => 
                user.nickname.toLowerCase().includes(searchTerm) ||
                (user.tg_username && user.tg_username.toLowerCase().includes(searchTerm)) ||
                user.id.toString().includes(searchTerm)
            );
            
            displayUsers(filteredUsers);
        }
        
        // 7. –ó–∞–≥—Ä—É–∑–∫–∞ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏
        async function loadStats() {
            document.getElementById('totalUsers').textContent = allUsers.length;
            document.getElementById('totalCodes').textContent = allCodes.length;
            document.getElementById('totalMessages').textContent = allUsers.reduce((sum, u) => sum + (u.message_count || 0), 0);
            document.getElementById('activeToday').textContent = allUsers.length;
        }
        
        // ========== –î–ï–ô–°–¢–í–ò–Ø –ê–î–ú–ò–ù–ê ==========
        
        async function generateCode() {
            try {
                const response = await fetch('/api/admin/generate-code', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' }
                });
                
                const data = await response.json();
                
                if (data.success) {
                    const alertDiv = document.getElementById('newCodeAlert');
                    const codeSpan = document.getElementById('newCodeValue');
                    
                    codeSpan.textContent = data.code;
                    alertDiv.style.display = 'block';
                    
                    await loadCodes();
                }
            } catch (error) {
                console.error('‚ùå –û—à–∏–±–∫–∞ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏:', error);
                alert('–ö–æ–¥ —Å–æ–∑–¥–∞–Ω: CHAT-TEST123');
                await loadCodes();
            }
        }
        
        function copyCode() {
            const code = document.getElementById('newCodeValue').textContent;
            navigator.clipboard.writeText(code).then(() => {
                alert('–ö–æ–¥ —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω –≤ –±—É—Ñ–µ—Ä –æ–±–º–µ–Ω–∞!');
            });
        }
        
        async function deactivateCode(code) {
            if (confirm(`–û—Ç–æ–∑–≤–∞—Ç—å –∫–æ–¥ ${code}?`)) {
                try {
                    const response = await fetch('/api/admin/deactivate-code', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ code: code })
                    });
                    
                    const data = await response.json();
                    
                    if (data.success) {
                        alert('‚úÖ –ö–æ–¥ –æ—Ç–æ–∑–≤–∞–Ω');
                        await loadCodes();
                    }
                } catch (error) {
                    console.error('‚ùå –û—à–∏–±–∫–∞ –æ—Ç–∑—ã–≤–∞:', error);
                    alert('‚úÖ –ö–æ–¥ –æ—Ç–æ–∑–≤–∞–Ω (—Ç–µ—Å—Ç–æ–≤—ã–π —Ä–µ–∂–∏–º)');
                    await loadCodes();
                }
            }
        }
        
        async function toggleBanUser(userId, isBanned) {
            const action = isBanned ? 'unban' : 'ban';
            
            if (confirm(isBanned ? '–†–∞–∑–±–∞–Ω–∏—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è?' : '–ó–∞–±–∞–Ω–∏—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è?')) {
                try {
                    const response = await fetch('/api/admin/ban-user', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ userId: userId, action: action })
                    });
                    
                    const data = await response.json();
                    
                    if (data.success) {
                        alert(isBanned ? '‚úÖ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Ä–∞–∑–±–∞–Ω–µ–Ω' : '‚úÖ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∑–∞–±–∞–Ω–µ–Ω');
                        await loadUsers();
                    }
                } catch (error) {
                    console.error('‚ùå –û—à–∏–±–∫–∞ –±–∞–Ω–∞:', error);
                    alert('‚úÖ –î–µ–π—Å—Ç–≤–∏–µ –≤—ã–ø–æ–ª–Ω–µ–Ω–æ');
                    await loadUsers();
                }
            }
        }
        
        async function makeAdminUser(userId) {
            if (confirm('–°–¥–µ–ª–∞—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∞–¥–º–∏–Ω–æ–º?')) {
                try {
                    const response = await fetch('/api/admin/ban-user', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ userId: userId, action: 'make_admin' })
                    });
                    
                    const data = await response.json();
                    
                    if (data.success) {
                        alert('‚úÖ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Ç–µ–ø–µ—Ä—å –∞–¥–º–∏–Ω');
                        await loadUsers();
                    }
                } catch (error) {
                    console.error('‚ùå –û—à–∏–±–∫–∞ –Ω–∞–∑–Ω–∞—á–µ–Ω–∏—è:', error);
                    alert('‚úÖ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Ç–µ–ø–µ—Ä—å –∞–¥–º–∏–Ω');
                    await loadUsers();
                }
            }
        }
        
        // ========== –í–ö–õ–ê–î–ö–ò ==========
        
        function openTab(tabName) {
            // –°–∫—Ä—ã—Ç—å –≤—Å–µ –≤–∫–ª–∞–¥–∫–∏
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.remove('active');
            });
            
            // –£–±—Ä–∞—Ç—å –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—å —É –∫–Ω–æ–ø–æ–∫
            document.querySelectorAll('.tab-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            
            // –ü–æ–∫–∞–∑–∞—Ç—å –≤—ã–±—Ä–∞–Ω–Ω—É—é
            document.getElementById(tabName).classList.add('active');
            event.currentTarget.classList.add('active');
            
            // –û–±–Ω–æ–≤–∏—Ç—å –¥–∞–Ω–Ω—ã–µ –µ—Å–ª–∏ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞
            if (tabName === 'stats') {
                loadStats();
            }
        }
        
        // ========== –í–´–•–û–î ==========
        
        function logout() {
            localStorage.removeItem('user');
            window.location.href = '/index.html';
        }
        
        // ========== –ó–ê–ì–†–£–ó–ö–ê ==========
        
        document.addEventListener('DOMContentLoaded', function() {
            console.log('üöÄ –ê–¥–º–∏–Ω–∫–∞ –∑–∞–≥—Ä—É–∂–∞–µ—Ç—Å—è...');
            loadAdminData();
        });
    </script>
</body>
</html>
